<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8"/>
<title>Larraun Kartela Paginado</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

  

/* ================= BASE ================= */

body{
  margin:0;
  background:#1b4d31;
  font-family:"Trebuchet MS","Arial Black",sans-serif;
}

.exportar{
  text-align:center;
  margin:18px;
}

/* ================= A3 ================= */
/* A3 vertical realista */
.pagina{
  width:900px;
  margin:30px auto;
  display:flex;
  flex-direction:column;
  background:#3f8159;
  position:relative;
  box-shadow:0 0 18px rgba(0,0,0,.4);
}


/* ================= HEADER ================= */

.header{
  height:120px;
  position:relative;

  display:flex;
  align-items:center;
  justify-content:center;

  /* degradado SIMPLE (html2canvas s칤 lo pinta bien) */
  background:linear-gradient(#3d6fe6, #2448b5);

  /* solo 1 sombra interior ligera (las m칰ltiples fallan) */
  box-shadow: inset 0 -10px 18px rgba(0,0,0,.35);
}

/* brillo superior falso (elemento real, no shadow) */
.header::after{
  content:"";
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:35px;

  background:linear-gradient(rgba(255,255,255,.35), transparent);
}



/* logos laterales M츼S GRANDES */
.logo-izq,.logo-der{
  position:absolute;
  top:18px;
  height:85px;
}
.logo-izq{ left:14px; }
.logo-der{ right:14px; }

/* t칤tulo M츼S curvado */
.titulo-curvo{
  width:100%;
  height:100px;
}

.titulo-curvo text{
  font-size:34px;
  font-weight:900;
  fill:white;
  letter-spacing:2px;
}

/* pelota M츼S peque침a y M츼S arriba */
.pelota-real{
  position:absolute;
  top:65px;
  left:50%;
  transform:translateX(-50%);

  width:30px;
  height:30px;
  border-radius:50%;

  background:
    radial-gradient(circle at 35% 30%,
      #ffffff 0%,
      #f5f5f5 40%,
      #e2e2e2 65%,
      #cfcfcf 100%
    );

  border:1.5px solid #d9d9d9;

  box-shadow:
    inset -4px -6px 10px rgba(0,0,0,.35),
    inset 4px 4px 8px rgba(255,255,255,.9),
    0 3px 5px rgba(0,0,0,.4);
}

.pelota-real::before,
.pelota-real::after{
  content:"";
  position:absolute;
  width:80%;
  height:42%;
  left:10%;
  border-top:1.8px solid #c40000;
  border-radius:50%;
  opacity:.85;
}

.pelota-real::before{ top:6px; }
.pelota-real::after{ bottom:6px; }

/* ================= CHAPAS ================= */

.chapa{
  height:12px;
  background:#000;
}

/* ================= PELOTAZOS ================= */

.pelotazos{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:20;
  mix-blend-mode:multiply;
}

.pelota-dot{
  position:absolute;
  border-radius:50%;
  background:#000;
  opacity:.25;
}

/* ================= CONTENIDO ================= */

.contenido{
  flex:1;
  padding:20px;
  overflow:hidden;
}

/* ================= BLOQUES ================= */

.bloque h2{
  text-align:center;
  margin:24px 0 16px 0;
  color:#f2f2f2;
  font-size:26px;
  font-weight:900;
  letter-spacing:3px;

  text-shadow:
    0 2px 0 #fff,
    0 -2px 0 rgba(0,0,0,.5),
    2px 3px 4px rgba(0,0,0,.6);
}

/* ================= PARTIDOS ================= */

.grupo{
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:8px;
}

.grupo-header{
  padding:6px 12px;
  font-weight:bold;
  color:#fff;
  background:#2448b5;
  font-size:13px;
}

.grupo-header.rojo{
  background:#b00000;
}

.linea{
  display:flex;
  padding:6px 10px;
  border-top:1px solid #ddd;
  font-size:13px;
  align-items:center;
  font-weight:900;
  border-radius:4px;
}
.larraun{
  font-weight:900;
  font-size:15px;
}
/* 4% */
.zkia{
  flex:0 0 4%;
}

/* 32% */
.etxekoa{
  flex:0 0 32%;
  color:#103c54;
}

/* 32% */
.kanpokoa{
  flex:0 0 32%;
  color:#b00000;
}
.equipo{
  line-height:1.1;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  word-break:break-word;
}
/* 32% */
.lehiaketa{
  flex:0 0 32%;
  text-align:right;
  font-size:12px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:4px;
}
.fase{
  font-size:10px;              /* m치s peque침a */
  font-weight:700;
  padding:2px 6px;
  border-radius:6px;
  background:#e7d3c2;          /* beige elegante */
  color:#5a2d0c;
  white-space:nowrap;
  letter-spacing:.5px;
}
.fase-finala{
  background:linear-gradient(45deg,#c9a227,#f7e27a);
  color:#000;
  font-weight:900;
  font-size:11px;
  box-shadow:0 0 6px rgba(0,0,0,.3);
}
 /* ================= FOOTER ================= */

.footer{
  display:flex;
  flex-direction:column;
}

.chapa{
  height:12px;
  background:#000;
}

.pie-gris{
  padding:14px 12px;

  background:linear-gradient(#4a4a4a, #2f2f2f);

  box-shadow:
    inset 0 10px 14px rgba(255,255,255,.25),
    inset 0 -12px 18px rgba(0,0,0,.6);
}

.logos-grid{
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:8px;
}

.logo-item{
  background:#fff;
  padding:6px;
  border-radius:6px;
}

.logo-item img{
  width:100%;
  height:36px;
  object-fit:contain;
}

</style>
</head>

<body>

<div class="exportar">
<button onclick="exportar()">游닞 DESKARGATU KARTELA</button>
</div>

<div id="contenedorPaginas"></div>

<script>

  let FASES = {};
  let CATEGORIAS = {};

/* ================= CREAR HEADER/FOOTER REUTILIZABLE ================= */

function crearHeader(){
 return `
 <div class="header">
   <img src="images/logo-larraun.png" class="logo-izq">
   <img src="images/logo-fnp.png" class="logo-der">

   <svg class="titulo-curvo" viewBox="0 0 900 120">
     <path id="arco" d="M60,110 Q450,-60 840,110" fill="transparent"/>
     <text text-anchor="middle">
       <textPath href="#arco" startOffset="50%">LARRAUN PILOTA ELKARTEA</textPath>
     </text>
   </svg>

   <div class="pelota-real"></div>
 </div>
 <div class="chapa"></div>
 `;
}

function crearFooter(){
 return `
 <div class="chapa"></div>

<div class="footer">
  <div class="pie-gris">
    <div class="logos-grid"></div>
  </div>
</div>

 `;
}

/* ================= CREAR NUEVA P츼GINA ================= */

function nuevaPagina(){

 const p=document.createElement("div");
 p.className="pagina";

 const pel=document.createElement("div");
 pel.className="pelotazos";
 p.appendChild(pel);

 p.insertAdjacentHTML("beforeend",
   crearHeader()+
   `<div class="contenido"></div>`+
   crearFooter()
 );

 document.getElementById("contenedorPaginas").appendChild(p);

 rellenarLogos(p);

 return p.querySelector(".contenido");
}

function generarPelotazos(contenedor){

 const altura = document.querySelector(".pagina").scrollHeight;

 for(let i=0;i<6000;i++){

   const d=document.createElement("div");
   const s=Math.random()*4+2;

   d.className="pelota-dot";
   d.style.width=d.style.height=s+"px";
   d.style.left=Math.random()*900+"px";
   d.style.top=Math.random()*altura+"px";

   contenedor.appendChild(d);
 }
}

function rellenarLogos(pagina){

 const LOGOS=[
 "aliprox.jpg","arbeondo.jpg","asadorepeleta.jpg","barainhoa.jpg","kotxera.jpg",
 "barilargi.jpg","barlekuonberri.jpg","bego침ajanaridenda.jpg","carniceriaartxueta.jpg",
 "carpinteriahnosazpiroz.jpg","construccionesga침arbe.jpg","construccionesgarciarenasaralegi.jpg",
 "construccionesurangasaigos.jpg","hotelayestaran.jpg",
 "iseelectricidad.jpg","kattagorrielkartea.jpg","lacturale.jpg","lagunasesoria.jpg",
 "maderasnasorena.jpg","maskarada.jpg","suacontrol.jpg","urzubi.jpg",
 "ventamugiro.jpg","dietistaanagurrea.jpg","ekin.jpg",
 "farmaciaitziarmendia.png","fontaneriabalenciaga.jpg","fontaneriairibarren.jpg",
 "izarberri.png","lakita.jpg","sidreriatokialai.jpg","tallereslarraun.jpg",
 "talleresotxotorena.jpg","veterinarialekunberri.jpg"
 ];

 const grid=pagina.querySelector(".logos-grid");

 grid.innerHTML = LOGOS
   .map(f=>`<div class="logo-item"><img src="images/patrocinio/${f}"></div>`)
   .join("");
}

  
/* ================= CREAR BLOQUES PARTIDOS ================= */
function formatearEquipo(texto){

  if(!texto) return "";

  // Inserta salto justo antes del par칠ntesis
  return texto.replace(" (","<br>(");
}
function formatearLehiaketa(texto){

  if(!texto) return "";

  const fasesOrdenadas = Object.values(FASES)
    .sort((a,b)=> b.length - a.length);  // 游댠 m치s largas primero

  for(const fase of fasesOrdenadas){

    const regex = new RegExp(`\\b${fase}\\b`, "g");

    if(regex.test(texto)){
      let claseExtra = "";

if(fase.toUpperCase() === "FINALA"){
  claseExtra = " fase-finala";
}

texto = texto.replace(
  regex,
  `<span class="fase${claseExtra}">${fase}</span>`
);
    }
  }

  return texto;
}
function generarClasesCategorias(){

  const style = document.createElement("style");
  let css = "";

  for(const cat in CATEGORIAS){

    css += `
      .cat-${cat}{
        background:${CATEGORIAS[cat]};
      }
    `;
  }

  style.innerHTML = css;
  document.head.appendChild(style);
}
function obtenerClaseCategoria(texto){

  if(!texto) return "";

  const textoLower = texto.toLowerCase();

  for(const cat in CATEGORIAS){

    if(textoLower.includes(cat.toLowerCase())){
      return "cat-"+cat;
    }
  }

  return "";
}

function crearBloques(titulo,data){

 if(!data || data.length===0) return [];

 const arr=[];

 const h2=document.createElement("div");
 h2.className="bloque";
 h2.innerHTML=`<h2>${titulo}</h2>`;
 arr.push(h2);

 const dataFiltrada = data.filter(p=>{

   const e=(p.etxekoa||"").toLowerCase();
   const k=(p.kanpokoak||"").toLowerCase();

   return !(
     e.includes("descanso") ||
     e.includes("atseden") ||
     k.includes("descanso") ||
     k.includes("atseden")
   );
 });

 dataFiltrada.sort((a,b)=>{

   const fechaA = new Date(a.fecha.replace(/\//g,"-"));
   const fechaB = new Date(b.fecha.replace(/\//g,"-"));

   if(fechaA - fechaB !== 0) return fechaA - fechaB;

   if(a.hora !== b.hora){
     return a.hora.localeCompare(b.hora);
   }

   return (a.fronton || "").localeCompare(b.fronton || "");
 });

 const grupos={};

 dataFiltrada.forEach(p=>{

   const key = p.fecha+"|"+p.hora+"|"+p.fronton;

   if(!grupos[key]) grupos[key]=[];
   grupos[key].push(p);
 });

 Object.values(grupos).forEach(partidos=>{

   const g=document.createElement("div");
   g.className="grupo";

   const fronton = partidos[0].fronton || "";

   const esLocal =
     fronton.toLowerCase().includes("lekunberri") ||
     fronton.toLowerCase().includes("aldatz");

   const colorClase = esLocal ? "" : " rojo";

   g.innerHTML=`
     <div class="grupo-header${colorClase}">
       ${partidos[0].fecha} | ${partidos[0].hora} | ${fronton}
     </div>
     ${partidos.map(p=>{

  let etx = formatearEquipo(p.etxekoa);
  let kan = formatearEquipo(p.kanpokoak);

  if(etx.toLowerCase().includes("larraun")){
    etx = "<strong>"+etx+"</strong>";
  }

  if(kan.toLowerCase().includes("larraun")){
    kan = "<strong>"+kan+"</strong>";
  }

  return `
    <div class="linea ${obtenerClaseCategoria(p.lehiaketa)}">
      <div class="zkia">${p.zkia}</div>
      <div class="etxekoa">${etx}</div>
      <div class="kanpokoa">${kan}</div>
      <div class="lehiaketa">${formatearLehiaketa(p.lehiaketa)}</div>
    </div>
  `;
}).join("")}
   `;

   arr.push(g);
 });

 return arr;
}

/* ================= FETCH + CONSTRUIR ================= */

Promise.all([
 fetch("data/cartelera-larraun.json").then(r=>r.json()),
 fetch("data/partidos-no-oficiales.json").then(r=>r.json()),
 fetch("data/fases.json").then(r=>r.json()),
 fetch("data/categoriacartel.json").then(r=>r.json())
]).then(([oficiales,noOficiales,fases,categorias])=>{

 FASES = fases;
 CATEGORIAS = categorias;

 generarClasesCategorias();   // 游댠 ESTO FALTABA

 const bloques=[
   ...crearBloques("NEPF PARTIDUAK",oficiales),
   ...crearBloques("BESTE TXAPELKETAK OFIZIALAK",noOficiales.filter(p=>p.ofiziala==="true")),
   ...crearBloques("TXAPELKETAK EZ OFIZIALAK",noOficiales.filter(p=>p.ofiziala!=="true"))
 ];

 const contenido = nuevaPagina();

 bloques.forEach(b=>contenido.appendChild(b));

 const pel = document.querySelector(".pelotazos");
 generarPelotazos(pel);

});
/* ================= EXPORTAR ================= */

async function exportar(){

 const pagina=document.querySelector(".pagina");

 const canvas=await html2canvas(pagina,{
   scale:2,
   useCORS:true
 });

 const a=document.createElement("a");
 a.href=canvas.toDataURL("image/jpeg",0.95);
 a.download="kartela-completo.jpg";
 a.click();
}

</script>

</body>
</html>
