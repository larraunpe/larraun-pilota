<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservas Front贸n y Trinquete</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="users.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0 }
.hidden { display:none }
.login, .app { max-width:1000px; margin:auto; padding:20px }
input, button { padding:10px; margin:6px 0; width:100%; max-width:300px }
button { background:#333; color:white; border:none; border-radius:6px; cursor:pointer }

.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:20px }
.day { background:white; padding:10px; border-radius:6px; text-align:center; cursor:pointer }

.hours { display:grid; grid-template-columns:repeat(6,1fr); gap:6px; margin-top:20px }
.hour { padding:8px; border-radius:6px; text-align:center; cursor:pointer }
.fronton { background:#bde7ff }
.trinquete { background:#c7f5d9 }
.hour.selected { background:#ffb3b3!important }

.admin { background:#222; color:white; padding:15px; margin-top:30px }
.space-btn {
  padding:10px 16px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  margin-right:10px;
}

.space-btn.fronton {
  background:#4fc3f7; /* azul celeste */
  color:#00324d;
}

.space-btn.trinquete {
  background:#66d19e; /* verde */
  color:#0b3d2e;
}

</style>
</head>

<body>

<div class="login" id="login">
  <h2>Acceso a reservas</h2>
  <input id="user" placeholder="Usuario">
  <input id="pass" type="password" placeholder="Contrase帽a">
  <button onclick="login()">Entrar</button>
  <p id="msg" style="color:red"></p>
</div>

<div class="app hidden" id="app">
  <h2 id="welcome"></h2>

<button class="space-btn fronton" onclick="setSpace('fronton')">Front贸n</button>
<button class="space-btn trinquete" onclick="setSpace('trinquete')">Trinquete</button>

  <h3 id="spaceTitle"></h3>

  <div id="calendar" class="calendar"></div>
  <div id="hours" class="hours"></div>

  <button onclick="confirmReservation()">Confirmar reserva</button>

  <div id="adminPanel" class="admin hidden">
    <h3>Panel administrador</h3>
    <button onclick="exportCSV()">Exportar Excel</button>
    <pre id="adminData"></pre>
  </div>
</div>

<script>
let currentUser=null, role=null, space=null, selectedDay=null, selectedHours=[]
let reservations=[]

const loginDiv=document.getElementById("login")
const app=document.getElementById("app")
const welcome=document.getElementById("welcome")

function login(){
  const u=user.value.trim()
  const p=pass.value.trim()

  if(window.users && users[u] && users[u].year===p){
    currentUser=u
    role=users[u].role
    loginDiv.classList.add("hidden")
    app.classList.remove("hidden")
    welcome.textContent="Bienvenido "+users[u].name
    if(role==="admin") adminPanel.classList.remove("hidden")
    buildCalendar()
  } else {
    msg.textContent="Credenciales incorrectas"
  }
}

function setSpace(s){
  space=s
  selectedHours=[]
  hours.innerHTML=""
  spaceTitle.textContent="Reservando "+(s==="fronton"?"Front贸n":"Trinquete")
}

function buildCalendar(){
  calendar.innerHTML=""
  const today=new Date()
  const max=role==="admin"?21:7
  for(let i=0;i<max;i++){
    const d=new Date(today)
    d.setDate(today.getDate()+i)
    const div=document.createElement("div")
    div.className="day"
    div.textContent=d.toISOString().slice(0,10)
    div.onclick=()=>selectDay(d)
    calendar.appendChild(div)
  }
}

function selectDay(d){
  selectedDay=d.toISOString().slice(0,10)
  buildHours()
}

function buildHours(){
  hours.innerHTML=""
  selectedHours=[]
  for(let h=8;h<22;h++){
    ["00","30"].forEach(m=>{
      const t=String(h).padStart(2,"0")+":"+m
      const div=document.createElement("div")
      div.className="hour "+space
      div.textContent=t
      div.onclick=()=>toggleHour(t,div)
      hours.appendChild(div)
    })
  }
}

function toggleHour(t,div){
  if(selectedHours.includes(t)){
    selectedHours=selectedHours.filter(x=>x!==t)
    div.classList.remove("selected")
  } else {
    if(selectedHours.length>=3 && role!=="admin") return
    selectedHours.push(t)
    div.classList.add("selected")
  }
}

function confirmReservation(){
  if(!space||!selectedDay||!selectedHours.length){
    alert("Completa la reserva")
    return
  }
  //  BLOQUEO DE SOLAPE FRONTN / TRINQUETE
  const conflict = reservations.some(r =>
    r.user === currentUser &&
    r.day === selectedDay &&
    r.space !== space &&
    r.hours.some(h => selectedHours.includes(h))
  )

  if(conflict && role !== "admin"){
    alert("No puedes reservar front贸n y trinquete a la misma hora")
    return
  }

  reservations.push({user:currentUser,space,day:selectedDay,hours:[...selectedHours]})
  const espacioTxt = space === "fronton" ? "Front贸n" : "Trinquete"
  alert(
    "Reserva confirmada\n\n" +
    "Espacio: " + espacioTxt + "\n" +
    "Fecha: " + selectedDay + "\n" +
    "Horas: " + selectedHours.join(", ")
  )
  selectedHours=[]
  hours.innerHTML=""
  adminData.textContent=JSON.stringify(reservations,null,2)
}


function exportCSV(){
  let csv="Usuario,Espacio,Fecha,Horas\n"
  reservations.forEach(r=>{
    csv+=`${r.user},${r.space},${r.day},"${r.hours.join(" ")}"\n`
  })
  const blob=new Blob([csv],{type:"text/csv"})
  const a=document.createElement("a")
  a.href=URL.createObjectURL(blob)
  a.download="reservas.csv"
  a.click()
}
</script>

</body>
</html>
