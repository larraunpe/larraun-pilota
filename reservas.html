<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservas Front칩n y Trinquete</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="users.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0; }
.login, .app { max-width:1000px; margin:auto; padding:20px; }
.hidden { display:none; }

.calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
  margin-top:15px;
}

.day {
  padding:10px;
  background:#fff;
  border-radius:6px;
  text-align:center;
  cursor:pointer;
}

.day.disabled {
  background:#ddd;
  color:#888;
  cursor:not-allowed;
}

.hours {
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:6px;
  margin-top:15px;
}

.hour {
  padding:8px;
  border-radius:6px;
  cursor:pointer;
  text-align:center;
}

.fronton-hour { background:#bde7ff; }
.trinquete-hour { background:#c7f5d9; }

.hour.selected { background:#ffb3b3; }
.hour.disabled { background:#ccc; cursor:not-allowed; }

.space-btn {
  padding:10px 16px;
  margin-right:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.fronton { background:#7ecbff; }
.trinquete { background:#7fe0b0; }

.admin {
  background:#222;
  color:#fff;
  padding:15px;
  margin-top:20px;
}
</style>
</head>

<body>

<div class="login" id="login">
  <h2>Acceso a reservas</h2>
  <input id="user" placeholder="Usuario"><br><br>
  <input id="pass" type="password" placeholder="Contrase침a"><br><br>
  <button onclick="login()">Entrar</button>
  <p id="msg" style="color:red;"></p>
</div>

<div class="app hidden" id="app">
  <h2 id="welcome"></h2>

  <button class="space-btn fronton" onclick="setSpace('fronton')">Front칩n</button>
  <button class="space-btn trinquete" onclick="setSpace('trinquete')">Trinquete</button>

  <h3 id="spaceTitle"></h3>

  <div class="calendar" id="calendar"></div>
  <div class="hours" id="hours"></div>

  <button onclick="confirmReservation()">Confirmar reserva</button>

  <div class="admin hidden" id="adminPanel">
    <h3>Vista administrador</h3>
    <button onclick="exportCSV()">Exportar a Excel</button>
    <pre id="adminData"></pre>
  </div>
</div>

<script>
let currentUser, role;
let space = null;
let selectedDay = null;
let selectedHours = [];
let reservations = [];

function login(){
  const u = user.value.trim();
  const p = pass.value.trim();

  if (users[u] && users[u].year === p) {
    currentUser = u;
    role = users[u].role;

    login.classList.add("hidden");
    app.classList.remove("hidden");

    welcome.textContent = "Bienvenido " + users[u].name;

    if (role === "admin") {
      adminPanel.classList.remove("hidden");
    }

    buildCalendar();
  } else {
    msg.textContent = "Credenciales incorrectas";
  }
}

function setSpace(s){
  space = s;
  spaceTitle.textContent = "Reservando: " + (s === "fronton" ? "Front칩n" : "Trinquete");
  selectedHours = [];
  hours.innerHTML = "";
}

function buildCalendar(){
  calendar.innerHTML = "";
  const today = new Date();
  const maxDays = role === "admin" ? 21 : 7;

  for(let i = 0; i < maxDays; i++){
    const d = new Date(today);
    d.setDate(today.getDate() + i);

    const div = document.createElement("div");
    div.className = "day";
    div.textContent = d.toISOString().slice(0,10);
    div.onclick = () => selectDay(d);

    calendar.appendChild(div);
  }
}

function selectDay(d){
  selectedDay = d.toISOString().slice(0,10);
  buildHours();
}

function buildHours(){
  hours.innerHTML = "";
  selectedHours = [];

  for(let h = 8; h < 22; h++){
    ["00","30"].forEach(m => {
      const t = `${h.toString().padStart(2,"0")}:${m}`;
      const div = document.createElement("div");

      div.className = "hour " + (space === "fronton" ? "fronton-hour" : "trinquete-hour");
      div.textContent = t;

      div.onclick = () => toggleHour(t, div);
      hours.appendChild(div);
    });
  }
}

function toggleHour(t, div){
  if (selectedHours.includes(t)) {
    selectedHours = selectedHours.filter(x => x !== t);
    div.classList.remove("selected");
  } else {
    if (selectedHours.length >= 3 && role !== "admin") return;
    selectedHours.push(t);
    div.classList.add("selected");
  }
}

function confirmReservation(){
  if (!space || !selectedDay || selectedHours.length === 0) {
    alert("Completa todos los pasos");
    return;
  }

  reservations.push({
    user: currentUser,
    name: users[currentUser].name,
    space,
    day: selectedDay,
    hours: [...selectedHours]
  });

  alert("Reserva confirmada en " + space);
  selectedHours = [];
  hours.innerHTML = "";

  updateAdmin();
}

function updateAdmin(){
  adminData.textContent = JSON.stringify(reservations, null, 2);
}

function exportCSV(){
  let csv = "Usuario,Nombre,Espacio,Fecha,Horas\n";
  reservations.forEach(r => {
    csv += `${r.user},${r.name},${r.space},${r.day},"${r.hours.join(" ")}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "reservas.csv";
  a.click();
}
</script>

</body>
</html>
  
