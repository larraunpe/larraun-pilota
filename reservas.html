<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservas Frontón y Trinquete</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="users.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0 }
.hidden { display:none }

.login, .app {
  max-width:1000px;
  margin:auto;
  padding:20px;
}

input, button {
  padding:10px;
  margin:6px 0;
  width:100%;
  max-width:300px;
}

button {
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
  margin-top:20px;
}

.day {
  background:#fff;
  padding:8px;
  border-radius:6px;
  text-align:center;
  cursor:pointer;
  font-size:13px;
}

.day.active.fronton { background:#4fc3f7; color:#00324d }
.day.active.trinquete { background:#66d19e; color:#0b3d2e }

.hours {
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:6px;
  margin-top:20px;
}

.hour {
  padding:8px;
  border-radius:6px;
  text-align:center;
  cursor:pointer;
}

.hour.selected { background:#ffb3b3 !important }

.hour.disabled {
  background:#ddd !important;
  color:#888;
  cursor:not-allowed;
}

.fronton { background:#bde7ff }
.trinquete { background:#c7f5d9 }

.space-btn {
  padding:10px 16px;
  font-weight:bold;
  border-radius:6px;
  margin-right:10px;
}

.space-btn.fronton { background:#4fc3f7; color:#00324d }
.space-btn.trinquete { background:#66d19e; color:#0b3d2e }

.admin {
  background:#222;
  color:#fff;
  padding:15px;
  margin-top:30px;
}
</style>
</head>

<body>

<div class="login" id="login">
  <h2>Erreserbetarako sarbidea</h2>
  <h2>Acceso a reservas</h2>
  <input id="user" placeholder="Erabiltzea/Usuario">
  <input id="pass" type="password" placeholder="Pasahitza/Contraseña">
  <button onclick="login()">Sartu/Entrar</button>
  <p id="msg" style="color:red"></p>
</div>

<div class="app hidden" id="app">
  <h2 id="welcome"></h2>

  <button class="space-btn fronton" onclick="setSpace('fronton')">Frontón</button>
  <button class="space-btn trinquete" onclick="setSpace('trinquete')">Trinquete</button>

  <h3 id="spaceTitle"></h3>

  <div id="calendar" class="calendar"></div>
  <div id="hours" class="hours"></div>

  <button onclick="confirmReservation()">Confirmar reserva</button>
  <button onclick="sendWhatsApp()">Enviar por WhatsApp</button>

  <div id="qrBox" class="hidden" style="margin-top:20px;text-align:center">
    <h4>QR de la reserva</h4>
    <img id="qrImg">
  </div>

  <div id="adminPanel" class="admin hidden">
    <h3>Panel administrador</h3>
    <button onclick="exportCSV()">Exportar Excel</button>
    <pre id="adminData"></pre>
  </div>
</div>

<script>
// Referencias a elementos del DOM
const loginDiv = document.getElementById("login")
const app = document.getElementById("app")
const welcome = document.getElementById("welcome")
const adminPanel = document.getElementById("adminPanel")
const calendar = document.getElementById("calendar")
const hours = document.getElementById("hours")
const spaceTitle = document.getElementById("spaceTitle")
const qrBox = document.getElementById("qrBox")
const qrImg = document.getElementById("qrImg")
const adminData = document.getElementById("adminData")
let currentUser=null, role=null
let space=null, selectedDay=null, selectedHours=[]
let reservations=[], lastReservation=null
let selectedDayDiv=null

const daysEU = ["ig.","al.","as.","az.","og.","or.","lr."]
const daysES = ["DOM","LUN","MAR","MIE","JUE","VIE","SAB"]

function login(){
  const u=user.value.trim()
  const p=pass.value.trim()

  if(users[u] && users[u].year===p){
    currentUser=u
    role=users[u].role
    loginDiv.classList.add("hidden")
    app.classList.remove("hidden")
    welcome.textContent="Bienvenido "+users[u].name
    if(role==="admin") adminPanel.classList.remove("hidden")
    buildCalendar()
  } else msg.textContent="Credenciales incorrectas"
}

function setSpace(s){
  space=s
  selectedHours=[]
  hours.innerHTML=""
  spaceTitle.textContent="Reservando "+(s==="fronton"?"Frontón":"Trinquete")
}

function buildCalendar(){
  calendar.innerHTML=""
  const today=new Date()
  const max=role==="admin"?21:8

  for(let i=0;i<max;i++){
    const d=new Date(today)
    d.setDate(today.getDate()+i)

    const dow=d.getDay()
    const div=document.createElement("div")
    div.className="day"
    div.innerHTML=
      daysEU[dow].toUpperCase()+"<br>"+
      daysES[dow]+"<br>"+
      d.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit"})

    div.onclick=()=>selectDay(d,div)
    calendar.appendChild(div)
  }
}

function selectDay(d,div){
  selectedDay=d.toISOString().slice(0,10)
  if(selectedDayDiv) selectedDayDiv.classList.remove("active","fronton","trinquete")
  div.classList.add("active",space)
  selectedDayDiv=div
  buildHours()
}

function buildHours(){
  hours.innerHTML=""
  selectedHours=[]
  const now=new Date()

  for(let h=8;h<22;h++){
    ["00","30"].forEach(m=>{
      const t=String(h).padStart(2,"0")+":"+m
      const div=document.createElement("div")
      div.className="hour "+space
      div.textContent=t

      const slot=new Date(selectedDay+"T"+t)
      const diff=(slot-now)/60000

      if(selectedDay===now.toISOString().slice(0,10) && diff<-15){
        div.classList.add("disabled")
      } else {
        div.onclick=()=>toggleHour(t,div)
      }
      hours.appendChild(div)
    })
  }
}

function toggleHour(t,div){
  if(div.classList.contains("disabled")) return
  if(selectedHours.includes(t)){
    selectedHours=selectedHours.filter(x=>x!==t)
    div.classList.remove("selected")
  } else {
    if(selectedHours.length>=3 && role!=="admin") return
    selectedHours.push(t)
    div.classList.add("selected")
  }
}

function confirmReservation(){
  if(!space||!selectedDay||!selectedHours.length){
    alert("Aukeratu frontoia edo trinketea, eguna eta ordutegia.\n\nSelecciona frontón o trinquete, el día y el horario.")
    return
  }

  reservations.push({user:currentUser,space,day:selectedDay,hours:[...selectedHours]})
  lastReservation=reservations.at(-1)

  alert("Reserva confirmada\n\n"+selectedDay+"\n"+selectedHours.join(", "))
  selectedHours=[]
  hours.innerHTML=""
}

function showQR(t){
  qrImg.src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="+encodeURIComponent(t)
  qrBox.classList.remove("hidden")
}

function sendWhatsApp(){
  if(!lastReservation){alert("Primero confirma una reserva");return}
  const msg="Reserva Larraun Pilota\n"+lastReservation.day+"\n"+lastReservation.hours.join(", ")
  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank")
}

function exportCSV(){
  let csv="Usuario,Espacio,Fecha,Horas\n"
  reservations.forEach(r=>csv+=`${r.user},${r.space},${r.day},"${r.hours.join(" ")}"\n`)
  const a=document.createElement("a")
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}))
  a.download="reservas.csv"
  a.click()
}
</script>

</body>
</html>
