<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8"/>

<title>Larraun â€“ Emaitzak</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- ================= FUENTES SCOREBOARD ================= -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Press+Start+2P&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>

/* ================= BASE ================= */

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#184d33;
}

button{
  margin:18px;
  padding:10px 18px;
}

/* ================= PAGINA ================= */

.pagina{
  width:900px;
  margin:auto;
  background:#eef4ff;
}

/* ================= HEADER PRINCIPAL ================= */

.header{
  height:115px;
  background:linear-gradient(#163a7a,#0b2350);
  color:#9cff9c;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;

  /* pixel LCD */
  font-family:'Press Start 2P', monospace;
  font-size:18px;
  letter-spacing:2px;
}

.header img{
  position:absolute;
  height:80px;
}

.logo-izq{left:20px}
.logo-der{right:20px}

/* ================= FOOTER ================= */

.footer{
  height:40px;
  background:#222;
  color:#eee;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
}

/* ================= BLOQUES ================= */

.titulo{
  font-family:'Orbitron', sans-serif;
  font-size:18px;
  font-weight:800;
  background:#111;
  color:#fff;
  text-align:center;
  padding:6px;
  margin:14px 0 6px;
  letter-spacing:1px;
}

/* ================= PARTIDO ================= */

.partido{
  margin-bottom:7px;
  border-radius:6px;
  overflow:hidden;
}

/* ===== pelotazos verdes (20 pequeÃ±os) ===== */
.win{
  background:
  radial-gradient(circle 10px at 10% 20%, #42d65a, transparent 11px),
  radial-gradient(circle 8px  at 20% 70%, #34c653, transparent 9px),
  radial-gradient(circle 12px at 30% 40%, #3fd15d, transparent 13px),
  radial-gradient(circle 9px  at 40% 80%, #39c457, transparent 10px),
  radial-gradient(circle 10px at 50% 30%, #33b94c, transparent 11px),
  radial-gradient(circle 11px at 60% 60%, #3acb58, transparent 12px),
  radial-gradient(circle 9px  at 70% 15%, #36c152, transparent 10px),
  radial-gradient(circle 8px  at 80% 45%, #42d65a, transparent 9px),
  radial-gradient(circle 10px at 90% 75%, #3bd35a, transparent 11px),
  #e7faec;
}

/* ===== pelotazos rojos suaves ===== */
.lose{
  background:
  radial-gradient(circle 10px at 12% 25%, #ff9a9a, transparent 11px),
  radial-gradient(circle 9px  at 25% 70%, #ff8d8d, transparent 10px),
  radial-gradient(circle 12px at 40% 45%, #ff9f9f, transparent 13px),
  radial-gradient(circle 8px  at 55% 80%, #ff8a8a, transparent 9px),
  radial-gradient(circle 10px at 70% 35%, #ff9494, transparent 11px),
  radial-gradient(circle 9px  at 85% 60%, #ff8d8d, transparent 10px),
  #ffeaea;
}

.pending{
  background:#f2f2f2;
}

/* ================= HEADER PARTIDO ================= */

.partido-header{
  font-size:11px;
  font-weight:800;
  text-align:center;
  padding:4px;
  color:white;
  text-decoration:none;
  display:block;
}

.azul{ background:#2f5fd2; }
.granate{ background:#8b3a4a; }

/* ================= FILA ================= */

.fila{
  display:grid;
  grid-template-columns: 2fr 11fr 4fr 11fr 2fr;
  align-items:center;
  padding:8px 10px;
}

.fila > *{min-width:0}

/* ================= LOGOS ================= */

.logo{
  width:60px;
  height:60px;
  object-fit:contain;
}

.fila img:first-child{justify-self:start}
.fila img:last-child{justify-self:end}

/* ================= EQUIPOS ================= */

.local,.visit{
  display:flex;
  flex-direction:column;
  font-size:20px;
}

.visit{text-align:right}

.principal{
  font-weight:900;
  line-height:1.05;
}

.detalle{
  font-size:.45em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  opacity:.65;
}

.local .principal{color:#0d47a1}
.visit .principal{color:#b71c1c}

/* ================= MARCADOR DIGITAL ================= */

.score{
  text-align:center;
  font-family:'Share Tech Mono', monospace; /* estilo DS-digital */
  font-size:34px;
  font-weight:900;
  letter-spacing:2px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.sets{
  font-size:.33em;
  margin-top:2px;
  opacity:.7;
}

.blue{color:#0d47a1}
.red{color:#b71c1c}

</style>
</head>

<body>

<button onclick="exportar()">ðŸ“¸ DESKARGATU JPG</button>
<div id="contenedor"></div>

<script>

/* ================= SEMANAS ================= */

function monday(d){
  const x=new Date(d);
  const day=x.getDay()||7;
  if(day!==1) x.setDate(x.getDate()-day+1);
  x.setHours(0,0,0,0);
  return x;
}

function filtrarSemanas(data){
  const today=new Date();
  const thisMon=monday(today);
  const lastMon=new Date(thisMon);
  lastMon.setDate(lastMon.getDate()-7);

  return data.filter(p=>{
    const f=new Date(p.fecha+"T00:00");
    return f>=lastMon && f<=today;
  });
}

/* ================= ORDEN ================= */

function ordenar(lista){

  return lista.sort((a,b)=>{

    const pa=!a.tanteoa;
    const pb=!b.tanteoa;

    if(pa!==pb) return pa?1:-1; // pendientes al final

    const da=new Date(a.fecha+" "+(a.hora||"00:00"));
    const db=new Date(b.fecha+" "+(b.hora||"00:00"));

    if(da-db!==0) return da-db;

    return (a.fronton||"").localeCompare(b.fronton||"");
  });
}

/* ================= UTIL ================= */

function normalizar(n){
  return n.split("(")[0].replace(/[.,]/g,"").trim().replace(/\s+/g,"-").toUpperCase();
}

function logoClub(nombre){
  const n=normalizar(nombre);
  if(n.includes("LARRAUN"))
    return `<img class="logo" src="images/logo-larraun.png">`;
  return `<img class="logo" src="images/clubes/${n}.jpg" onerror="this.style.visibility='hidden'">`;
}

function bloqueEquipo(texto,clase){
  const partes=texto.split(")");
  const principal=partes[0]+")";
  const detalle=partes.slice(1).join(")").trim();

  return `
    <div class="${clase}">
      <div class="principal">${principal}</div>
      ${detalle?`<div class="detalle">${detalle}</div>`:""}
    </div>`;
}

function estado(p){
  if(!p.tanteoa) return "pending";

  const [a,b]=p.tanteoa.split("-").map(Number);
  const larraunLocal=p.etxekoa.toUpperCase().includes("LARRAUN");

  return larraunLocal ? (a>b?"win":"lose") : (b>a?"win":"lose");
}

/* ================= PARTIDO ================= */

function crearPartido(p){

  const [a,b]=(p.tanteoa||"-").split("-");
  const est=estado(p);

  const f=(p.fronton||"").toLowerCase();
  const color=(f.includes("lekunberri")||f.includes("aldaz"))?"azul":"granate";

  return `
  <div class="partido ${est}">
    <a href="${p.url||'#'}" target="_blank" class="partido-header ${color}">
      ${p.fecha} Â· ${p.fronton} Â· ${p.modalidad}
    </a>

    <div class="fila">
      ${logoClub(p.etxekoa)}
      ${bloqueEquipo(p.etxekoa,"local")}

      <div class="score">
        <div><span class="blue">${a||""}</span> - <span class="red">${b||""}</span></div>
        ${p.sets?.length?`<div class="sets">${p.sets.join(" ")}</div>`:""}
      </div>

      ${bloqueEquipo(p.kanpokoak,"visit")}
      ${logoClub(p.kanpokoak)}
    </div>
  </div>`;
}

/* ================= SECCION ================= */

function crearSeccion(titulo,data,lista){
  if(!data.length) return;

  lista.insertAdjacentHTML("beforeend",`<div class="titulo">${titulo}</div>`);

  ordenar(data).forEach(p=>{
    lista.insertAdjacentHTML("beforeend",crearPartido(p));
  });
}

/* ================= CARGA ================= */

Promise.all([
 fetch("data/resultados-larraun.json").then(r=>r.json()),
 fetch("data/resultados-no-oficiales.json").then(r=>r.json())
]).then(([larraun,no])=>{

  const pagina=document.createElement("div");
  pagina.className="pagina";

  pagina.innerHTML=`
  <div class="header">
    <img src="images/logo-larraun.png" class="logo-izq">
    EMAITZAK - LARRAUN PILOTA ELKARTEA
    <img src="images/logo-fnp.png" class="logo-der">
  </div>
  <div id="lista"></div>
  <div class="footer">Larraun Pilota Elkartea</div>
  `;

  contenedor.appendChild(pagina);

  const lista=document.getElementById("lista");

  crearSeccion("NKJ EMAITZAK", filtrarSemanas(larraun), lista);
  crearSeccion("BESTE TXAPELKETAK OFIZIALAK", filtrarSemanas(no.filter(p=>p.ofiziala)), lista);
  crearSeccion("TXAPELKETAK EZ OFIZIALAK", filtrarSemanas(no.filter(p=>!p.ofiziala)), lista);
});

/* ================= EXPORT ================= */

async function exportar(){
 const c=await html2canvas(document.querySelector(".pagina"),{scale:2,useCORS:true});
 const a=document.createElement("a");
 a.href=c.toDataURL("image/jpeg",0.95);
 a.download="emaitzak.jpg";
 a.click();
}

</script>

</body>
</html>
