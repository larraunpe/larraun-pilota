<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8"/>
<title>Larraun â€“ Emaitzak</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#184d33;
}

button{
  padding:10px 18px;
  font-weight:bold;
  margin:18px;
  cursor:pointer;
}

/* ================= PAGINA ================= */

.pagina{
  width:900px;
  height:1270px;
  margin:auto;
  background:#eef4ff;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.header{
  height:110px;
  background:linear-gradient(#3d6fe6,#2448b5);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.header img{
  position:absolute;
  height:80px;
}

.logo-izq{left:20px}
.logo-der{right:20px}

.footer{
  height:40px;
  background:#444;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
}

.contenido{
  flex:1;
  padding:6px;
  overflow:hidden;
}

/* ================= SECCIONES ================= */

.titulo-seccion{
  background:#222;
  color:#fff;
  text-align:center;
  font-size:13px;
  font-weight:900;
  padding:4px;
  margin:6px 0;
}

.grupo{
  background:white;
  border-radius:8px;
  overflow:hidden;
  margin-bottom:6px;
}

.grupo-header{
  font-size:10px;
  padding:3px;
  text-align:center;
  font-weight:700;
}

.azul{background:#dbe7ff;color:#0d47a1}
.rojo{background:#ffe0e0;color:#b71c1c}

/* ================= FILA ================= */

.fila{
  display:grid;

  /* proporciÃ³n EXACTA 2-11-4-11-2 */
  grid-template-columns:
    6.7%   /* logo local */
    36.6%  /* etxekoa */
    13.4%  /* tanteoa */
    36.6%  /* kanpokoak */
    6.7%;  /* logo visit */

  align-items:center;
  height:95px;
  padding:0 6px;
}




.logo{
  width:50px;
  height:50px;
  object-fit:contain;
}

.nombre{
  font-weight:150;
  font-size:22px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.local .nombre{color:#0d47a1}
.visit .nombre{color:#b71c1c}

.pelotaris{
  font-size:9px;
  opacity:.6;
}

.score{
  text-align:center;
  font-size:46px;
  font-weight:900;
}

.blue{color:#0d47a1}
.red{color:#b71c1c}

.sets{
  font-size:10px;
}

</style>
</head>

<body>

<button onclick="exportar()">ðŸ“¸ DESKARGATU JPG</button>
<div id="contenedor"></div>

<script>

/* ================= FECHAS ================= */

function monday(d){
  const x=new Date(d);
  const day=x.getDay()||7;
  if(day!==1) x.setDate(x.getDate()-day+1);
  return x;
}

function filtrar(data){
  const today=new Date();
  today.setHours(0,0,0,0);

  const thisMon=monday(today);
  const lastMon=new Date(thisMon);
  lastMon.setDate(thisMon.getDate()-7);

  return data.filter(p=>{
    const f=new Date(p.fecha+"T00:00");
    return f>=lastMon && f<=today;
  });
}

/* ================= DEDUPLICADO (FIX) ================= */

function quitarDuplicados(lista){
  const vistos=new Set();
  return lista.filter(p=>{
    const id =
      p.fecha+"|"+
      p.fronton+"|"+
      p.modalidad+"|"+
      p.etxekoa+"|"+
      p.kanpokoak+"|"+
      p.tanteoa;

    if(vistos.has(id)) return false;
    vistos.add(id);
    return true;
  });
}

/* ================= LOGOS ================= */

function normalizar(nombre){
  return nombre
    .split("(")[0]
    .replace(/[.,]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .toUpperCase();
}

function logoClub(nombre){

  const n=normalizar(nombre);

  if(n.includes("LARRAUN"))
    return `<img class="logo" src="images/logo-larraun.png">`;

  return `<img class="logo" src="images/clubes/${n}.jpg" onerror="this.style.display='none'">`;
}

/* ================= FILA ================= */

function crearFila(p){

  const [a,b]=(p.tanteoa||"-").split("-");

  const fila=document.createElement("div");
  fila.className="fila";

  fila.innerHTML=`

    ${logoClub(p.etxekoa)}

    <div class="local">
      <div class="nombre">${p.etxekoa}</div>
      ${p.pelotaris_local?`<div class="pelotaris">${p.pelotaris_local}</div>`:""}
    </div>

    <div class="score">
      <span class="blue">${a||""}</span> -
      <span class="red">${b||""}</span>
    </div>

    <div class="visit">
      <div class="nombre">${p.kanpokoak}</div>
      ${p.pelotaris_visit?`<div class="pelotaris">${p.pelotaris_visit}</div>`:""}
    </div>

    ${logoClub(p.kanpokoak)}

  `;

  return fila;
}


/* ================= SECCIONES ================= */

function crearSeccion(titulo,data,cont){

  if(!data.length) return;

  const t=document.createElement("div");
  t.className="titulo-seccion";
  t.textContent=titulo;
  cont.appendChild(t);

  const g=document.createElement("div");
  g.className="grupo";

  quitarDuplicados(data).forEach(p=>g.appendChild(crearFila(p)));

  cont.appendChild(g);
}

/* ================= CARGA ================= */

Promise.all([
 fetch("data/resultados-larraun.json").then(r=>r.json()),
 fetch("data/resultados-no-oficiales.json").then(r=>r.json())
]).then(([larraun,no])=>{

  const cont=nuevaPagina();

  crearSeccion("NKJ TXAPELKETAK", filtrar(larraun), cont);
  crearSeccion("BESTE TXAPELKETAK OFIZIALAK", filtrar(no).filter(p=>p.ofiziala==="bai"), cont);
  crearSeccion("TXAPELKETAK EZ OFIZIALAK", filtrar(no).filter(p=>p.ofiziala!=="bai"), cont);

});

/* ================= PAGINA ================= */

function nuevaPagina(){
  const p=document.createElement("div");
  p.className="pagina";

  p.innerHTML=`
    <div class="header">
      <img src="images/logo-larraun.png" class="logo-izq">
      <h1>EMAITZAK</h1>
      <img src="images/logo-fnp.png" class="logo-der">
    </div>
    <div class="contenido"></div>
    <div class="footer">Larraun Pilota Elkartea</div>
  `;

  document.getElementById("contenedor").appendChild(p);

  return p.querySelector(".contenido");
}

/* ================= EXPORT ================= */

async function exportar(){
 const p=document.querySelector(".pagina");
 const c=await html2canvas(p,{scale:2,useCORS:true});
 const a=document.createElement("a");
 a.href=c.toDataURL("image/jpeg",0.95);
 a.download="emaitzak.jpg";
 a.click();
}

</script>
</body>
</html>
