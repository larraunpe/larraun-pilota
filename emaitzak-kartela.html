<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8"/>
<title>Larraun ‚Äì Emaitzak</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

/* ================= BASE ================= */

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#184d33;
}

button{
  padding:10px 18px;
  font-weight:bold;
  cursor:pointer;
  margin:18px;
}

/* ================= P√ÅGINA ================= */

.pagina{
  width:900px;
  height:1270px;
  margin:20px auto;
  background:#eef4ff;
  display:flex;
  flex-direction:column;
  box-shadow:0 0 18px rgba(0,0,0,.35);
}

.header{height:110px}
.footer{height:40px}
.contenido{height:1120px; overflow:hidden; padding:10px}

/* ================= HEADER ================= */

.header{
  background:linear-gradient(#3d6fe6,#2448b5);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.header img{
  position:absolute;
  height:70px;
}

.logo-izq{left:20px}
.logo-der{right:20px}

.header h1{
  letter-spacing:3px;
}

/* ================= BLOQUES ================= */

.titulo-seccion{
  background:#222;
  color:#fff;
  font-size:14px;
  font-weight:800;
  padding:5px 10px;
  margin:8px 0 4px;
  text-align:center;
}

.grupo{
  background:#fff;
  border-radius:8px;
  overflow:hidden;
  margin-bottom:8px;
}

.grupo-header{
  font-size:11px;
  padding:4px;
  text-align:center;
  font-weight:700;
}

.azul{background:#dbe7ff;color:#0d47a1}
.rojo{background:#ffe0e0;color:#b71c1c}

/* ================= FILA ================= */

.fila{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 70px;
  border-top:1px solid #ddd;
}

.win{background:#e7f6ea}
.lose{background:#fdeaea}
.pending{background:#f3f3f3}

/* logos M√ÅS GRANDES */
.logo{
  height:52px;
  width:52px;
  object-fit:contain;
}

/* equipos */
.equipo{
  display:flex;
  align-items:center;
  gap:8px;
  width:40%;
}

.local{justify-content:flex-end; text-align:right}
.visit{justify-content:flex-start}

/* nombres */
.nombre{
  font-weight:900;
  font-size:16px;
}

.pelotaris{
  font-size:8px;
  opacity:.8;
}

/* marcador CENTRO ABSOLUTO */
.score{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-size:32px;
  font-weight:900;
  text-align:center;
  min-width:90px;
}

.blue{color:#0d47a1}
.red{color:#b71c1c}
.sets{font-size:10px}

/* footer */

.footer{
  background:#444;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
}

a{color:inherit;text-decoration:underline}

</style>
</head>

<body>

<button onclick="exportar()">üì∏ DESKARGATU JPG</button>

<div id="contenedor"></div>

<script>

/* ================= FECHAS ================= */

function monday(d){
  const x=new Date(d);
  const day=x.getDay()||7;
  if(day!==1) x.setDate(x.getDate()-day+1);
  return x;
}

function filtrar(data){
  const today=new Date();
  today.setHours(0,0,0,0);

  const thisMon=monday(today);
  const lastMon=new Date(thisMon);
  lastMon.setDate(thisMon.getDate()-7);

  return data.filter(p=>{
    const f=new Date(p.fecha+"T00:00");
    return f>=lastMon && f<=today;
  });
}

/* ================= LOGOS ================= */

function logoClub(nombre){

  if(!nombre) return "";

  const n=nombre.toUpperCase().trim();

  if(n.includes("LARRAUN"))
    return `<img class="logo" src="images/logo-larraun.png">`;

  const limpio=n.replace(/\s+/g,"-");

  return `<img class="logo" src="images/clubes/${limpio}.jpg"
          onerror="this.style.display='none'">`;
}

/* ================= P√ÅGINA ================= */

function nuevaPagina(){
  const p=document.createElement("div");
  p.className="pagina";

  p.innerHTML=`
  <div class="header">
    <img src="images/logo-larraun.png" class="logo-izq">
    <h1>EMAITZAK</h1>
    <img src="images/logo-fnp.png" class="logo-der">
  </div>
  <div class="contenido"></div>
  <div class="footer">Larraun Pilota Elkartea</div>
  `;

  document.getElementById("contenedor").appendChild(p);

  return p.querySelector(".contenido");
}

/* ================= CREAR FILA ================= */

function crearFila(p){

  const fila=document.createElement("div");

  const estado=(p.emaitza||"").toLowerCase();
  fila.className="fila "+(!estado?"pending":estado==="irabazita"?"win":"lose");

  const [a,b]=(p.tanteoa||"-").split("-");

  fila.innerHTML=`

    <div class="equipo local">
      <div>
        <div class="nombre">${p.etxekoa}</div>
        ${p.pelotaris_local ?
          `<div class="pelotaris">${p.pelotaris_local}</div>`:""}
      </div>
      ${logoClub(p.etxekoa)}
    </div>

    <div class="score">
      <span class="blue">${a||""}</span> -
      <span class="red">${b||""}</span>
      ${p.sets?.length?`<div class="sets">${p.sets.join(" ")}</div>`:""}
    </div>

    <div class="equipo visit">
      ${logoClub(p.kanpokoak)}
      <div>
        <div class="nombre">${p.kanpokoak}</div>
        ${p.pelotaris_visit ?
          `<div class="pelotaris">${p.pelotaris_visit}</div>`:""}
      </div>
    </div>
  `;

  return fila;
}

/* ================= BLOQUES ================= */

function crearSeccion(titulo, data, cont){

  if(!data.length) return;

  const t=document.createElement("div");
  t.className="titulo-seccion";
  t.textContent=titulo;
  cont.appendChild(t);

  const grupos={};

  data.forEach(p=>{
    const key=p.fecha+"|"+p.fronton+"|"+p.modalidad;
    if(!grupos[key]) grupos[key]=[];
    grupos[key].push(p);
  });

  Object.values(grupos).forEach(partidos=>{

    const p0=partidos[0];

    const g=document.createElement("div");
    g.className="grupo";

    const link=p0.url?`<a href="${p0.url}" target="_blank">${p0.modalidad}</a>`:p0.modalidad;

    g.innerHTML=`
      <div class="grupo-header ${p0.etxekoa.includes("LARRAUN")?'azul':'rojo'}">
        ${p0.fronton} ¬∑ ${p0.fecha} ¬∑ ${link}
      </div>
    `;

    partidos.forEach(p=>g.appendChild(crearFila(p)));

    cont.appendChild(g);
  });
}

/* ================= CARGA DATOS ================= */

Promise.all([
 fetch("data/resultados-larraun.json").then(r=>r.json()),
 fetch("data/resultados-no-oficiales.json").then(r=>r.json())
]).then(([larraun,noOficial])=>{

  const contenido=nuevaPagina();

  const filtradosLar=filtrar(larraun);
  const filtradosNo=filtrar(noOficial);

  const ofizial=filtradosNo.filter(p=>p.ofiziala==="bai");
  const ez=filtradosNo.filter(p=>p.ofiziala!=="bai");

  crearSeccion("NKJ TXAPELKETAK", filtradosLar, contenido);
  crearSeccion("BESTE TXAPELKETAK OFIZIALAK", ofizial, contenido);
  crearSeccion("TXAPELKETAK EZ OFIZIALAK", ez, contenido);
});

/* ================= EXPORTAR ================= */

async function exportar(){
 const paginas=document.querySelectorAll(".pagina");
 let i=1;
 for(const p of paginas){
   const c=await html2canvas(p,{scale:2,useCORS:true});
   const a=document.createElement("a");
   a.href=c.toDataURL("image/jpeg",0.95);
   a.download=`emaitzak-${i}.jpg`;
   a.click();
   i++;
 }
}

</script>
</body>
</html>
