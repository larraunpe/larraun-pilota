<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8"/>
<title>Larraun ‚Äì EMAITZAK</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

/* ================= BASE ================= */

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#184d33;
}

.exportar{
  text-align:center;
  margin:16px;
}

button{
  padding:10px 18px;
  font-weight:bold;
  cursor:pointer;
}

/* ================= A3 REALISTA ================= */

.pagina{
  width:900px;
  height:1270px;
  margin:30px auto;
  background:#eef4ff;
  display:flex;
  flex-direction:column;
  box-shadow:0 0 18px rgba(0,0,0,.4);
}

/* alturas FIJAS ‚Üí evita cortes */
.header{ height:110px; }
.footer{ height:40px; }
.contenido{
  height:1120px; /* 1270 - header - footer */
  overflow:hidden;
  padding:12px;
}

/* ================= HEADER ================= */

.header{
  background:linear-gradient(#3d6fe6,#2448b5);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.header h1{
  font-size:32px;
  letter-spacing:3px;
}

.header img{
  position:absolute;
  height:65px;
  top:20px;
}
.logo-izq{ left:20px }
.logo-der{ right:20px }

/* ================= GRUPOS ================= */

.grupo{
  background:#fff;
  border-radius:8px;
  overflow:hidden;
  margin-bottom:10px;
}

.grupo-header{
  text-align:center;
  font-size:11px;
  padding:3px;
  font-weight:700;
  letter-spacing:1px;
}

.azul{ background:#dbe7ff; color:#0d47a1 }
.rojo{ background:#ffe0e0; color:#b71c1c }

/* ================= FILA RESULTADO ================= */

.fila{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:6px 6px;
  border-top:1px solid #ddd;
  font-weight:900;
}

/* estados */
.win{ background:#e7f6ea }
.lose{ background:#fdeaea }
.pending{ background:#f3f3f3 }

/* logos */
.logo{
  height:26px;
  width:26px;
  object-fit:contain;
}

/* nombres MUY pegados */
.local{
  color:#0d47a1;
  text-align:right;
  min-width:130px;
}

.visit{
  color:#b71c1c;
  text-align:left;
  min-width:130px;
}

/* marcador gigante centro */
.score{
  font-size:28px;
  font-weight:900;
  min-width:80px;
  text-align:center;
}

.blue{ color:#0d47a1 }
.red{ color:#b71c1c }

.sets{
  font-size:10px;
  font-weight:normal;
}

/* ================= FOOTER ================= */

.footer{
  background:#444;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
}

</style>
</head>

<body>

<div class="exportar">
<button onclick="exportar()">üì∏ DESKARGATU JPG</button>
</div>

<div id="contenedorPaginas"></div>

<script>

/* ======================================================
   FECHAS ‚Üí √∫ltimas 2 semanas lunes‚Üídomingo
====================================================== */

function monday(d){
  const x=new Date(d);
  const day=x.getDay()||7;
  if(day!==1) x.setDate(x.getDate()-day+1);
  x.setHours(0,0,0,0);
  return x;
}

function filtrar(data){
  const today=new Date();
  today.setHours(0,0,0,0);

  const thisMon=monday(today);
  const lastMon=new Date(thisMon);
  lastMon.setDate(thisMon.getDate()-7);

  return data.filter(p=>{
    const d=new Date(p.fecha+"T00:00");
    return d>=lastMon && d<=today;
  });
}

/* ======================================================
   LOGOS AUTOM√ÅTICOS
====================================================== */

function logoClub(nombre){

  if(!nombre) return "";

  const n = nombre.toUpperCase().trim();

  if(n.includes("LARRAUN"))
    return `<img class="logo" src="images/logo-larraun.png">`;

  const limpio = n.replace(/\s+/g,"");

  return `<img class="logo" src="images/clubes/${limpio}.jpg"
           onerror="this.style.display='none'">`;
}

/* ======================================================
   CREAR P√ÅGINA
====================================================== */

function nuevaPagina(){

  const p=document.createElement("div");
  p.className="pagina";

  p.innerHTML=`
    <div class="header">
      <img src="images/logo-larraun.png" class="logo-izq">
      <h1>EMAITZAK</h1>
      <img src="images/logo-fnp.png" class="logo-der">
    </div>
    <div class="contenido"></div>
    <div class="footer">Larraun Pilota Elkartea</div>
  `;

  document.getElementById("contenedorPaginas").appendChild(p);

  return p.querySelector(".contenido");
}

/* ======================================================
   CREAR BLOQUES
====================================================== */

function crearBloques(data){

  const grupos={};

  data.forEach(p=>{
    const key=p.fecha+"|"+p.hora+"|"+p.fronton+"|"+p.modalidad;
    if(!grupos[key]) grupos[key]=[];
    grupos[key].push(p);
  });

  const bloques=[];

  Object.values(grupos).forEach(partidos=>{

    const p0=partidos[0];

    const g=document.createElement("div");
    g.className="grupo";

    const esLocal=p0.etxekoa.toUpperCase().includes("LARRAUN");

    g.innerHTML=`
      <div class="grupo-header ${esLocal?'azul':'rojo'}">
        ${p0.fronton} ¬∑ ${p0.fecha} ¬∑ ${p0.hora} ¬∑ ${p0.modalidad}
      </div>
    `;

    partidos.forEach(p=>{

      const fila=document.createElement("div");

      const estado=(p.emaitza||"").toLowerCase();
      fila.className="fila " +
        (!estado?"pending":estado==="irabazita"?"win":"lose");

      const [a,b]=(p.tanteoa||"-").split("-");

      fila.innerHTML=`
        ${logoClub(p.etxekoa)}
        <div class="local">${p.etxekoa}</div>

        <div class="score">
          <span class="blue">${a||""}</span>-
          <span class="red">${b||""}</span>
          ${p.sets?.length?`<div class="sets">${p.sets.join(" ")}</div>`:""}
        </div>

        <div class="visit">${p.kanpokoak}</div>
        ${logoClub(p.kanpokoak)}
      `;

      g.appendChild(fila);
    });

    bloques.push(g);
  });

  return bloques;
}

/* ======================================================
   PAGINAR
====================================================== */

function paginar(bloques){

  let contenido=nuevaPagina();

  bloques.forEach(b=>{
    contenido.appendChild(b);

    if(contenido.scrollHeight>contenido.clientHeight){
      contenido.removeChild(b);
      contenido=nuevaPagina();
      contenido.appendChild(b);
    }
  });
}

/* ======================================================
   FETCH DATOS
====================================================== */

Promise.all([
 fetch("data/resultados-larraun.json").then(r=>r.json()),
 fetch("data/resultados-no-oficiales.json").then(r=>r.json())
]).then(([oficiales,noOficiales])=>{

  const data=filtrar([...oficiales,...noOficiales]);

  const bloques=crearBloques(data);

  paginar(bloques);
});

/* ======================================================
   EXPORTAR JPG
====================================================== */

async function exportar(){

 const paginas=document.querySelectorAll(".pagina");

 let i=1;

 for(const p of paginas){
   const canvas=await html2canvas(p,{scale:2,useCORS:true});
   const a=document.createElement("a");
   a.href=canvas.toDataURL("image/jpeg",0.95);
   a.download=`emaitzak-${i}.jpg`;
   a.click();
   i++;
 }
}

</script>

</body>
</html>
