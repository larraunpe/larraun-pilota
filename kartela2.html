<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8"/>
<title>Larraun Kartela Paginado</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

/* ================= BASE ================= */

body{
  margin:0;
  background:#1b4d31;
  font-family:"Trebuchet MS","Arial Black",sans-serif;
}

.exportar{
  text-align:center;
  margin:18px;
}

/* ================= A3 ================= */
/* A3 vertical realista */
.pagina{
  width:900px;
  height:1270px; /* proporci√≥n A3 */
  margin:30px auto;
  display:flex;
  flex-direction:column;
  background:#3f8159;
  position:relative;
  overflow:hidden;
  box-shadow:0 0 18px rgba(0,0,0,.4);
}

/* ================= HEADER ================= */

.header{
  height:120px;
  position:relative;

  display:flex;
  align-items:center;
  justify-content:center;

  /* degradado SIMPLE (html2canvas s√≠ lo pinta bien) */
  background:linear-gradient(#3d6fe6, #2448b5);

  /* solo 1 sombra interior ligera (las m√∫ltiples fallan) */
  box-shadow: inset 0 -10px 18px rgba(0,0,0,.35);
}

/* brillo superior falso (elemento real, no shadow) */
.header::after{
  content:"";
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:35px;

  background:linear-gradient(rgba(255,255,255,.35), transparent);
}



/* logos laterales M√ÅS GRANDES */
.logo-izq,.logo-der{
  position:absolute;
  top:18px;
  height:85px;
}
.logo-izq{ left:14px; }
.logo-der{ right:14px; }

/* t√≠tulo M√ÅS curvado */
.titulo-curvo{
  width:100%;
  height:100px;
}

.titulo-curvo text{
  font-size:34px;
  font-weight:900;
  fill:white;
  letter-spacing:2px;
}

/* pelota M√ÅS peque√±a y M√ÅS arriba */
.pelota-real{
  position:absolute;
  top:65px;          /* un poco m√°s arriba */
  left:50%;
  transform:translateX(-50%);

  width:30px;
  height:30px;
  border-radius:50%;

  /* degradado esf√©rico */
  background:
    radial-gradient(circle at 35% 30%,
      #ffffff 0%,
      #f5f5f5 40%,
      #e2e2e2 65%,
      #cfcfcf 100%
    );

  border:1.5px solid #d9d9d9;

  box-shadow:
    inset -4px -6px 10px rgba(0,0,0,.35), /* sombra interna */
    inset 4px 4px 8px rgba(255,255,255,.9), /* brillo */
    0 3px 5px rgba(0,0,0,.4); /* sombra exterior */
}

/* costuras rojas m√°s finas y realistas */
.pelota-real::before,
.pelota-real::after{
  content:"";
  position:absolute;
  width:80%;
  height:42%;
  left:10%;
  border-top:1.8px solid #c40000;
  border-radius:50%;
  opacity:.85;
}

.pelota-real::before{ top:6px; }
.pelota-real::after{ bottom:6px; }

/* ================= CHAPAS ================= */

.chapa{
  height:12px;
  background:#000;
}
/* ================= PELOTAZOS ================= */
  .pelotazos{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:20;            /* por delante de TODO */
  mix-blend-mode:multiply;
}

.pelota-dot{
  position:absolute;
  border-radius:50%;
  background:#000;
  opacity:.25;
}

/* ================= CONTENIDO ================= */

.contenido{
  flex:1;
  padding:20px;
  overflow:hidden;
}

/* ================= BLOQUES ================= */

.bloque h2{
  text-align:center;
  margin:24px 0 16px 0;
  color:#f2f2f2;
  font-size:26px;
  font-weight:900;
  letter-spacing:3px;

  text-shadow:
    0 2px 0 #fff,
    0 -2px 0 rgba(0,0,0,.5),
    2px 3px 4px rgba(0,0,0,.6);
}

/* ================= PARTIDOS ================= */

.grupo{
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:8px;
}

.grupo-header{
  padding:6px 12px;
  font-weight:bold;
  color:#fff;
  background:#2448b5;
  font-size:13px;
}

.grupo-header.rojo{
  background:#b00000;
}

.linea{
  display:flex;
  gap:8px;
  padding:6px 10px;
  border-top:1px solid #ddd;
  font-weight:900;
  font-size:13px;
}

.zkia{width:30px}
.etxekoa{color:#2448b5}
.kanpokoa{color:#b00000}
.lehiaketa{margin-left:auto}

/* ================= FOOTER COMPLETO ================= */

.footer{
  display:flex;
  flex-direction:column;
}

/* chapa negra */
.chapa{
  height:12px;
  background:#000;
}

/* colch√≥n gris tipo front√≥n */
.pie-gris{
  padding:14px 12px;

  /* degradado compatible html2canvas */
  background:linear-gradient(#4a4a4a, #2f2f2f);

  /* efecto acolchonado */
  box-shadow:
    inset 0 10px 14px rgba(255,255,255,.25),
    inset 0 -12px 18px rgba(0,0,0,.6);
}


/* patrocinadores */

.logos-grid{
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:8px;
}

.logo-item{
  background:#fff;
  padding:6px;
  border-radius:6px;
}

.logo-item img{
  width:100%;
  height:36px;
  object-fit:contain;
}
</style>
</head>

<body>

<div class="exportar">
<button onclick="exportar()">üì∏ DESKARGATU ORRI GUZTIAK</button>
</div>

<div id="contenedorPaginas"></div>


<script>

/* ================= CREAR HEADER/FOOTER REUTILIZABLE ================= */

function crearHeader(){
 return `
 <div class="header">
   <img src="images/logo-larraun.png" class="logo-izq">
   <img src="images/logo-fnp.png" class="logo-der">

   <svg class="titulo-curvo" viewBox="0 0 900 120">
     <path id="arco" d="M60,110 Q450,-60 840,110" fill="transparent"/>
     <text text-anchor="middle">
       <textPath href="#arco" startOffset="50%">LARRAUN PILOTA ELKARTEA</textPath>
     </text>
   </svg>

   <div class="pelota-real"></div>
 </div>
 <div class="chapa"></div>
 `;
}

function crearFooter(){
 return `
 <div class="chapa"></div>

<div class="footer">
  <div class="pie-gris">
    <div class="logos-grid"></div>
  </div>
</div>

 `;
}

/* ================= CREAR NUEVA P√ÅGINA ================= */

function nuevaPagina(){
 const p=document.createElement("div");
 p.className="pagina";
 p.innerHTML=crearHeader()+`<div class="contenido"></div>`+crearFooter();
 document.getElementById("contenedorPaginas").appendChild(p);
 // capa de pelotazos
 const pel=document.createElement("div");
 pel.className="pelotazos";
 p.appendChild(pel);

 p.insertAdjacentHTML("beforeend",
   crearHeader()+
   `<div class="contenido"></div>`+
   crearFooter()
 );
document.getElementById("contenedorPaginas").appendChild(p);

 generarPelotazos(pel);   // üëà MUY IMPORTANTE
 rellenarLogos(p);

 return p.querySelector(".contenido");
}
 rellenarLogos(p);   // üëà ESTA L√çNEA ES LA CLAVE

 return p.querySelector(".contenido");

}

function generarPelotazos(contenedor){

 for(let i=0;i<4500;i++){
   const d=document.createElement("div");
   const s=Math.random()*4+2;

   d.className="pelota-dot";
   d.style.width=d.style.height=s+"px";
   d.style.left=Math.random()*900+"px";
   d.style.top=Math.random()*1270+"px";

   contenedor.appendChild(d);
 }
}
function rellenarLogos(pagina){

 const LOGOS=[
 "aliprox.jpg","arbeondo.jpg","asadorepeleta.jpg","barainhoa.jpg","kotxera.jpg",
 "barilargi.jpg","barlekuonberri.jpg","bego√±ajanaridenda.jpg","carniceriaartxueta.jpg",
 "carpinteriahnosazpiroz.jpg","construccionesga√±arbe.jpg","construccionesgarciarenasaralegi.jpg",
 "construccionesurangasaigos.jpg","fisioterapiaandoniayerdi.jpg","hotelayestaran.jpg",
 "iseelectricidad.jpg","kattagorrielkartea.jpg","lacturale.jpg","lagunasesoria.jpg",
 "maderasnasorena.jpg","maskarada.jpg","sojonatura.jpg","suacontrol.jpg","urzubi.jpg",
 "ventamugiro.jpg","construccioneslansalot.jpg","dietistaanagurrea.jpg","ekin.jpg",
 "farmaciaitziarmendia.png","fontaneriabalenciaga.jpg","fontaneriairibarren.jpg",
 "izarberri.png","lakita.jpg","nekazari.jpg","sidreriatokialai.jpg","tallereslarraun.jpg",
 "talleresotxotorena.jpg","veterinarialekunberri.jpg"
 ];

 const grid=pagina.querySelector(".logos-grid");

 grid.innerHTML = LOGOS
   .map(f=>`<div class="logo-item"><img src="images/patrocinio/${f}"></div>`)
   .join("");
}



/* ================= PAGINACI√ìN REAL ================= */

function paginarBloques(bloques){

 let contenidoActual = nuevaPagina();

 for(let i=0; i<bloques.length; i++){

   const bloque = bloques[i];

   // Si es un t√≠tulo y el siguiente es un grupo, probamos juntos
   if(
     bloque.classList.contains("bloque") &&
     bloques[i+1] &&
     bloques[i+1].classList.contains("grupo")
   ){

     contenidoActual.appendChild(bloque);
     contenidoActual.appendChild(bloques[i+1]);

     if(contenidoActual.scrollHeight > contenidoActual.clientHeight){
       // no caben juntos ‚Üí nueva p√°gina
       contenidoActual.removeChild(bloque);
       contenidoActual.removeChild(bloques[i+1]);

       contenidoActual = nuevaPagina();
       contenidoActual.appendChild(bloque);
       contenidoActual.appendChild(bloques[i+1]);
     }

     i++; // saltamos el grupo ya procesado
     continue;
   }

   // comportamiento normal
   contenidoActual.appendChild(bloque);

   if(contenidoActual.scrollHeight > contenidoActual.clientHeight){
     contenidoActual.removeChild(bloque);
     contenidoActual = nuevaPagina();
     contenidoActual.appendChild(bloque);
   }
 }
}

/* ================= CREAR BLOQUES PARTIDOS ================= */

function crearBloques(titulo,data){

 if(!data || data.length===0) return [];

 const arr=[];

 const h2=document.createElement("div");
 h2.className="bloque";
 h2.innerHTML=`<h2>${titulo}</h2>`;
 arr.push(h2);

 const grupos={};

 data.forEach(p=>{
   const key=p.fecha+"|"+p.hora+"|"+p.fronton;
   if(!grupos[key]) grupos[key]=[];
   grupos[key].push(p);
 });

 Object.values(grupos).forEach(partidos=>{

   const g=document.createElement("div");   // üëà FALTABA ESTO
   g.className="grupo";

   const fronton = partidos[0].fronton || "";

   const esLocal =
     fronton.toLowerCase().includes("lekunberri") ||
     fronton.toLowerCase().includes("aldatz");

   const colorClase = esLocal ? "" : " rojo";

   g.innerHTML=`
     <div class="grupo-header${colorClase}">
       ${partidos[0].fecha} | ${partidos[0].hora} | ${fronton}
     </div>
     ${partidos.map(p=>`
       <div class="linea">
         <div class="zkia">${p.zkia}</div>
         <div class="etxekoa">${p.etxekoa}</div>
         <div class="kanpokoa">${p.kanpokoak}</div>
         <div class="lehiaketa">${p.lehiaketa}</div>
       </div>
     `).join("")}
   `;

   arr.push(g);
 });

 return arr;
}



/* ================= FETCH + CONSTRUIR ================= */

Promise.all([
 fetch("data/cartelera-larraun.json").then(r=>r.json()),
 fetch("data/partidos-no-oficiales.json").then(r=>r.json())
]).then(([oficiales,noOficiales])=>{

 const bloques=[
   ...crearBloques("ORDUTEGIAK",oficiales),
   ...crearBloques("BESTE TXAPELKETAK OFIZIALAK",noOficiales.filter(p=>p.ofiziala==="true")),
   ...crearBloques("TXAPELKETAK EZ OFIZIALAK",noOficiales.filter(p=>p.ofiziala!=="true"))
 ];

 paginarBloques(bloques);

});


/* ================= EXPORTAR TODAS LAS P√ÅGINAS ================= */

async function exportar(){

 const paginas=document.querySelectorAll(".pagina");

 let i=1;

 for(const p of paginas){

   const canvas=await html2canvas(p,{scale:2,useCORS:true});

   const a=document.createElement("a");
   a.href=canvas.toDataURL("image/jpeg",0.95);
   a.download=`kartela-${i}.jpg`;
   a.click();

   i++;
 }

}

</script>

</body>
</html>
