<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jaialdiak â€“ Larraun Pilota Elkartea</title>

<style>
body{font-family:Arial;background:#f4f4f4;padding:20px;}
h1{text-align:center;color:#33691e;margin-bottom:20px;}
table{width:100%;max-width:900px;margin:auto;border-collapse:collapse;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,.2);}
thead{background:#7cb342;}
th,td{padding:10px;border:1px solid #ccc;text-align:center;}
th{font-weight:900;}
input{width:100%;border:none;background:#e8f5e9;padding:6px;font-size:1em;}
input:focus{outline:2px solid #7cb342;}
.senior-bai{background:linear-gradient(90deg,#fffde7,#ffffff);}
.lateral-jaianjai{box-shadow:inset 6px 0 0 #1565c0;}
.lateral-trinkete{box-shadow:inset 6px 0 0 #2e7d32;}
.lateral-default{box-shadow:inset 6px 0 0 #3f51b5;}
</style>
</head>

<body>

<h1>JAIALDIAK</h1>

<table>
<thead>
<tr>
<th>EGUNA</th>
<th>ORDUA</th>
<th>LEKUA</th>
<th>ZB</th>
<th>SENIOR</th>
<th>EPAILEA(K)</th>
</tr>
</thead>
<tbody id="taula"></tbody>
</table>

<script>

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyj70d0n6jlVld_wE2QO8Hk8iF6gXuxHCcQZ36r4sC4raJF1DnMXxOkrvc0spWhWHwJ/exec";
const SENIOR_RE = /(NAGUSI|HELDUA|SENIOR|ESPAINA)/i;

let datosSheets = [];

/* =========================
   Cargar datos desde Sheets
========================= */
fetch(SCRIPT_URL)
  .then(r => r.json())
  .then(d => datosSheets = d || [])
  .catch(() => datosSheets = [])
  .finally(() => crearTabla());

/* =========================
   Guardar en Sheets
========================= */
function guardar(fecha, hora, fronton, value){

  fetch(SCRIPT_URL, {
    method:"POST",
    headers:{
      "Content-Type":"application/x-www-form-urlencoded"
    },
    body:
      `fecha=${encodeURIComponent(fecha)}`
      + `&hora=${encodeURIComponent(hora)}`
      + `&fronton=${encodeURIComponent(fronton)}`
      + `&epailea=${encodeURIComponent(value)}`
  });

}

/* =========================
   Utilidades
========================= */
function normalizaHora(h){
  if(!h) return "00:00";
  return h.slice(0,5);
}

/* =========================
   Crear tabla
========================= */
function crearTabla(){

Promise.all([
  fetch("data/cartelera-larraun.json").then(r=>r.json()),
  fetch("data/partidos-no-oficiales.json").then(r=>r.json())
]).then(([oficiales, noOficiales]) => {

  const data = [
    ...oficiales.map(p => ({ ...p, ofiziala:true })),
    ...noOficiales
  ];

  const jaialdiak = {};

  data.forEach(p => {

    if(!/lekunberri|aldatz/i.test(p.fronton||"")) return;

    const hora = normalizaHora(p.hora);
    const key = `${p.fecha}|${hora}|${p.fronton}`;

    if(!jaialdiak[key]){
      jaialdiak[key] = {
        fecha:p.fecha,
        hora:hora,
        fronton:p.fronton,
        zb:0,
        senior:"EZ"
      };
    }

    jaialdiak[key].zb++;

    const testua = `${p.lehiaketa||""} ${p.modalitatea||""}`;
    if(SENIOR_RE.test(testua)){
      jaialdiak[key].senior="BAI";
    }
  });

  const tbody = document.getElementById("taula");

  Object.values(jaialdiak)
    .sort((a,b)=> new Date(a.fecha+" "+a.hora) - new Date(b.fecha+" "+b.hora))
    .forEach(j => {

      const tr = document.createElement("tr");

      if(j.senior === "BAI") tr.classList.add("senior-bai");

      if(/jaian\s*jai/i.test(j.fronton)){
        tr.classList.add("lateral-jaianjai");
      } else if(/trinkete/i.test(j.fronton)){
        tr.classList.add("lateral-trinkete");
      } else {
        tr.classList.add("lateral-default");
      }

      // Buscar si existe guardado en Sheets
      const guardado = datosSheets.find(item =>
        item.fecha === j.fecha &&
        item.hora === j.hora &&
        item.fronton === j.fronton
      );

      const valorInicial = guardado ? guardado.epailea : "";

      tr.innerHTML = `
        <td>${j.fecha}</td>
        <td>${j.hora}</td>
        <td>${j.fronton}</td>
        <td><strong>${j.zb}</strong></td>
        <td><strong>${j.senior}</strong></td>
        <td>
          <input
            value="${valorInicial}"
            onchange="guardar('${j.fecha}', '${j.hora}', '${j.fronton}', this.value)"
          >
        </td>
      `;

      tbody.appendChild(tr);
    });

});
}

</script>

</body>
</html>
