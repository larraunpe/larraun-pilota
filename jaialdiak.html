<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jaialdiak â€“ Larraun Pilota Elkartea</title>

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f4f4f4;
  padding:20px;
}

h1{
  text-align:center;
  color:#33691e;
  margin-bottom:20px;
}

table{
  width:100%;
  max-width:900px;
  margin:auto;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
}

thead{
  background:#7cb342;
}

th, td{
  padding:10px;
  border:1px solid #ccc;
  text-align:center;
}

th{
  font-weight:900;
}

input{
  width:100%;
  border:none;
  background:#e8f5e9;
  padding:6px;
  font-size:1em;
}

input:focus{
  outline:2px solid #7cb342;
}

tr.senior-bai{
  background: linear-gradient(90deg, #fffde7, #ffffff);
}

tr.lateral-jaianjai{
  box-shadow: inset 6px 0 0 #1565c0;
}

tr.lateral-trinkete{
  box-shadow: inset 6px 0 0 #2e7d32;
}

tr.lateral-default{
  box-shadow: inset 6px 0 0 #3f51b5;
}

.lekua-jaianjai{
  background:#e3f2fd;
  color:#0d47a1;
  font-weight:700;
  padding:4px 6px;
  border-radius:6px;
}

.lekua-trinkete{
  background:#e8f5e9;
  color:#1b5e20;
  font-weight:700;
  padding:4px 6px;
  border-radius:6px;
}

.lekua-default{
  background:#e8eaf6;
  color:#1a237e;
  font-weight:700;
  padding:4px 6px;
  border-radius:6px;
}

.senior-bai-text{
  color:#e65100;
  font-weight:900;
}

.oharra{
  max-width:900px;
  margin:14px auto 0;
  font-size:.95em;
  color:#444;
  background:#eeeeee;
  padding:10px 14px;
  border-left:6px solid #7cb342;
  border-radius:6px;
}
</style>
</head>

<body>

<h1>JAIALDIAK</h1>

<table>
  <thead>
    <tr>
      <th>EGUNA</th>
      <th>ORDUA</th>
      <th>LEKUA</th>
      <th>ZB</th>
      <th>SENIOR</th>
      <th>EPAILEA(K)</th>
    </tr>
  </thead>
  <tbody id="taula"></tbody>
</table>

<div class="oharra">
* Jaialdien aurretik mopa pasa, markagailua eta aktak prestatu, sillak bere tokian jarri
</div>

<script>
const SENIOR_RE = /(NAGUSI|HELDUA|SENIOR|ESPAINA)/i;

let guardados = {};

/* =========================
   Cargar datos guardados
========================= */
fetch("api/load.php")
  .then(r => r.ok ? r.json() : {})
  .then(d => guardados = d || {})
  .catch(() => guardados = {})
  .finally(() => crearTabla());

/* =========================
   Guardar en servidor
========================= */
function guardar(id, value){
  fetch("api/save.php", {
    method:"POST",
    headers:{
      "Content-Type":"application/x-www-form-urlencoded"
    },
    body:`id=${encodeURIComponent(id)}&value=${encodeURIComponent(value)}`
  });
}

/* =========================
   Utilidades
========================= */
function normalizaHora(h){
  if(!h) return "00:00";
  return h.slice(0,5);
}

/* =========================
   Crear tabla
========================= */
function crearTabla(){

Promise.all([
  fetch("data/cartelera-larraun.json").then(r=>r.json()),
  fetch("data/partidos-no-oficiales.json").then(r=>r.json())
]).then(([oficiales, noOficiales]) => {

  const data = [
    ...oficiales.map(p => ({ ...p, ofiziala:true })),
    ...noOficiales
  ];

  const jaialdiak = {};

  data.forEach(p => {

    if(!/lekunberri|aldatz/i.test(p.fronton||"")) return;

    const hora = normalizaHora(p.hora);
    const key = `${p.fecha}|${hora}|${p.fronton}`;

    if(!jaialdiak[key]){
      jaialdiak[key] = {
        fecha:p.fecha,
        hora:hora,
        fronton:p.fronton,
        zb:0,
        senior:"EZ"
      };
    }

    jaialdiak[key].zb++;

    const testua = `${p.lehiaketa||""} ${p.modalitatea||""}`;
    if(SENIOR_RE.test(testua)){
      jaialdiak[key].senior="BAI";
    }
  });

  const tbody = document.getElementById("taula");

  Object.values(jaialdiak)
    .sort((a,b)=> new Date(a.fecha+" "+a.hora) - new Date(b.fecha+" "+b.hora))
    .forEach(j => {

      const tr = document.createElement("tr");

      if(j.senior === "BAI"){
        tr.classList.add("senior-bai");
      }

      if(/lekunberri\s*-\s*jaian\s*jai/i.test(j.fronton)){
        tr.classList.add("lateral-jaianjai");
      }
      else if(/lekunberri\s*-\s*trinkete/i.test(j.fronton)){
        tr.classList.add("lateral-trinkete");
      }
      else{
        tr.classList.add("lateral-default");
      }

      const id = `epailea_${j.fecha}_${j.hora}_${j.fronton}`;

      tr.innerHTML = `
        <td>${j.fecha}</td>
        <td>${j.hora}</td>
        <td>
          <span class="${
            /lekunberri\s*-\s*jaian\s*jai/i.test(j.fronton)
              ? 'lekua-jaianjai'
              : /lekunberri\s*-\s*trinkete/i.test(j.fronton)
                ? 'lekua-trinkete'
                : 'lekua-default'
          }">
            ${j.fronton}
          </span>
        </td>
        <td><strong>${j.zb}</strong></td>
        <td class="${j.senior === 'BAI' ? 'senior-bai-text' : ''}">
          <strong>${j.senior}</strong>
        </td>
        <td>
          <input
            value="${guardados[id] || ''}"
            oninput="guardar('${id}', this.value)"
          >
        </td>
      `;

      tbody.appendChild(tr);
    });

});
}
</script>

</body>
</html>
