<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Larraun ‚Äì Asteko Kartela</title>

<style>
body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background:
    linear-gradient(rgba(255,255,255,.85), rgba(255,255,255,.85)),
    url("https://larraunpilota.eus/asteko-kartela.jpg") center/cover no-repeat;
}

.cartel{
  max-width:900px;
  margin:20px auto;
  background:#ffffffcc;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.3);
  padding:20px 24px 30px;
}

/* CABECERA */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:16px;
}
.header img{height:64px;}
.header h1{
  margin:0;
  font-size:2em;
  letter-spacing:2px;
  color:#004d40;
}

/* BLOQUES */
.bloque{margin-top:26px;}
.bloque h2{
  margin:0 0 10px;
  font-size:1.4em;
  color:#1b5e20;
  border-bottom:3px solid #7cb342;
  padding-bottom:4px;
}

/* GRUPO */
.grupo{
  margin-top:14px;
  border-radius:8px;
  overflow:hidden;
  background:#fff;
  box-shadow:0 3px 8px rgba(0,0,0,.2);
}

.grupo-header{
  background:#e3f2fd;
  padding:10px 14px;
  font-weight:bold;
  color:#0d47a1;
}
.grupo-header.rojo{
  background:#f8d7da;
  color:#842029;
}
.grupo-header span{margin-right:14px;}

/* LINEA PARTIDO */
.linea{
  padding:8px 14px;
  border-top:1px solid #ddd;
  display:flex;
  align-items:flex-start;
  gap:10px;
  font-size:.95em;
}

.zkia{
  width:26px;
  font-weight:bold;
  color:#333;
  flex-shrink:0;
}

/* EQUIPOS */
.equipos{
  display:flex;
  flex-direction:column;
  flex:1;
}

.equipos .fila1{
  display:flex;
  gap:10px;
}

.equipos .fila2{
  margin-top:2px;
}

.etxekoa{color:#0d47a1;font-weight:bold;}
.kanpokoa{color:#b71c1c;font-weight:bold;}

.larraun{
  text-transform:uppercase;
  font-size:1.05em;
}

/* LEHIAKETA */
.lehiaketa{
  flex:1;
  color:#333;
  text-align:right;
}

.fase{
  font-weight:bold;
}
</style>
</head>

<body>

<div class="cartel">

  <div class="header">
    <img src="/images/logo-larraun.png" alt="Larraun">
    <h1>ASTEKO PARTIDUAK</h1>
    <img src="/images/logo-fnp.png" alt="FNP">
  </div>

  <div id="content"></div>

</div>

<script>
function normalizaHora(h){
  return h ? h.slice(0,5) : "00:00";
}

function detectarFase(t){
  const fases=[
    "FINAL LAURDENAK",
    "FINAL AURREKOAK",
    "FINALA",
    "LIGAXKA",
    "KANPORAKETA",
    "KAMPORAKETA"
  ];
  for(const f of fases){
    if(t.toUpperCase().includes(f)) return f;
  }
  return "";
}

function limpiarLehiaketa(t,f){
  return f ? t.replace(new RegExp(f,"i"),"").trim() : t;
}

function ordenar(data){
  return data.sort((a,b)=>{
    if(a.fecha!==b.fecha) return a.fecha.localeCompare(b.fecha);
    if(normalizaHora(a.hora)!==normalizaHora(b.hora))
      return normalizaHora(a.hora).localeCompare(normalizaHora(b.hora));
    return (a.fronton||"").localeCompare(b.fronton||"");
  });
}

function agrupar(data){
  const g={};
  data.forEach(p=>{
    const key=`${p.fecha}|${normalizaHora(p.hora)}|${p.fronton}`;
    if(!g[key]) g[key]=[];
    g[key].push(p);
  });
  Object.values(g).forEach(arr=>{
    arr.sort((a,b)=>(a.zkia||0)-(b.zkia||0));
  });
  return g;
}

Promise.all([
  fetch("/data/cartelera-larraun.json").then(r=>r.json()),
  fetch("/data/partidos-no-oficiales.json").then(r=>r.json())
]).then(([oficiales,noOficiales])=>{

  const bloques = [
    {titulo:"ORDUTEGIAK", data:ordenar(oficiales)},
    {titulo:"BESTE TXAPELKETAK OFIZIALAK",
     data:ordenar(noOficiales.filter(p=>String(p.ofiziala).toLowerCase()==="true"))},
    {titulo:"TXAPELKETAK EZ OFIZIALAK",
     data:ordenar(noOficiales.filter(p=>String(p.ofiziala).toLowerCase()!=="true"))}
  ];

  const cont=document.getElementById("content");

  bloques.forEach(b=>{
    if(!b.data.length) return;

    const grupos=agrupar(b.data);
    cont.innerHTML+=`<div class="bloque"><h2>${b.titulo}</h2></div>`;
    const bloqueDiv=cont.lastChild;

    Object.values(grupos).forEach(partidos=>{
      const p0=partidos[0];
      const esLocal=/lekunberri|aldatz/i.test(p0.fronton||"");

      bloqueDiv.innerHTML+=`
        <div class="grupo">
          <div class="grupo-header ${!esLocal?'rojo':''}">
            <span>üìÖ ${p0.fecha}</span>
            <span>‚è∞ ${normalizaHora(p0.hora)}</span>
            <span>üìç ${p0.fronton}</span>
          </div>

          ${partidos.map(p=>{
            const textoEquipos=(p.etxekoa||"")+" "+(p.kanpokoak||"");
            const doble=textoEquipos.length>60;
            const fase=detectarFase(p.lehiaketa||"");
            const lehiaketaLimpia=limpiarLehiaketa(p.lehiaketa||"",fase);

            return `
            <div class="linea">
              <div class="zkia">${p.zkia}</div>

              <div class="equipos">
                <div class="fila1">
                  <div class="etxekoa ${/larraun/i.test(p.etxekoa||"")?'larraun':''}">
                    ${p.etxekoa||""}
                  </div>
                </div>
                ${doble?`
                <div class="fila2">
                  <div class="kanpokoa ${/larraun/i.test(p.kanpokoak||"")?'larraun':''}">
                    ${p.kanpokoak||""}
                  </div>
                </div>`:
                `<div class="fila1">
                  <div class="kanpokoa ${/larraun/i.test(p.kanpokoak||"")?'larraun':''}">
                    ${p.kanpokoak||""}
                  </div>
                </div>`}
              </div>

              <div class="lehiaketa">
                ${lehiaketaLimpia}
                ${fase?` <span class="fase">(${fase})</span>`:""}
              </div>
            </div>`;
          }).join("")}

        </div>`;
    });
  });
});
</script>

</body>
</html>
