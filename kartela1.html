<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8">
<title>Larraun Kartela</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

/* ================= BASE ================= */

body{
  margin:0;
  background:#1b4d31;
  font-family:"Trebuchet MS","Arial Black",sans-serif;
}

.exportar{
  text-align:center;
  margin:18px;
}

/* ================= P√ÅGINA A4 ================= */

.pagina{
  width:900px;
  height:1400px;
  margin:25px auto;
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  background:#3f8159;
}

/* ================= CHAPAS ================= */

.chapa{
  height:12px;
  background:#000;
}

/* ================= HEADER ================= */

.header{
  height:160px;
  background:#2448b5;
  position:relative;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding-bottom:12px;

  box-shadow:
    inset 0 10px 14px rgba(255,255,255,.25),
    inset 0 -16px 22px rgba(0,0,0,.55);
}

.header img.logo{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  height:60px;
}

.header img.left{ left:20px; }
.header img.right{ right:20px; }

/* ================= SVG T√çTULO ================= */

.titulo-svg{
  width:100%;
  height:140px;
}

.titulo-svg text{
  fill:#fff;
  font-size:46px;
  font-weight:900;
  letter-spacing:3px;
}

/* pelota */
.pelota{
  fill:#f5f5f5;
  stroke:#ccc;
  stroke-width:2;
}
.costura{
  fill:none;
  stroke:#c00;
  stroke-width:2;
  stroke-dasharray:4 6;
}

/* ================= CONTENIDO ================= */

.contenido{
  flex:1;
  padding:16px 20px;
  overflow:hidden;
}

.bloque{
  margin-bottom:18px;
}

.bloque h2{
  color:#fff;
  text-align:center;
  margin:12px 0;
}

/* ================= PARTIDOS ================= */

.grupo{
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  margin-top:6px;
}

.grupo-header{
  padding:8px 14px;
  font-weight:bold;
  color:#fff;
  background:#2448b5;
}

.grupo-header.rojo{
  background:#b00000;
}

.linea{
  display:flex;
  padding:8px 10px;
  gap:8px;
  font-weight:900;
  border-top:1px solid #ddd;
}

.zkia{width:28px}
.etxekoa{color:#2448b5}
.kanpokoa{color:#b00000}
.lehiaketa{margin-left:auto}

/* ================= FOOTER ================= */

.footer{
  height:240px;
  display:flex;
  flex-direction:column;
}

.pie-gris{
  background:#2f2f2f;
  padding:10px;
}

.suelo{
  flex:1;
  background:#6b6b6b;
}

.logos-grid{
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:8px;
}

.logo-item{
  background:#fff;
  padding:6px;
  border-radius:6px;
}

.logo-item img{
  width:100%;
  height:36px;
  object-fit:contain;
}

/* ================= PELOTAZOS ================= */

.pelotazos{
  position:absolute;
  inset:0;
  pointer-events:none;
}

.pelota-bg{
  position:absolute;
  border-radius:50%;
  background:#000;
  opacity:.15;
}

</style>
</head>

<body>

<div class="exportar">
  <button onclick="exportar()">üì∏ DESKARGATU JPG</button>
</div>

<div id="paginas"></div>

<script>

/* ================= CONFIG ================= */

const CONTENIDO_MAX = 840;

/* ================= LOGOS ================= */

const LOGOS=[ /* igual que antes */ ];

function logosHTML(){
  return LOGOS.map(f =>
   `<div class="logo-item"><img src="/images/patrocinio/${f}"></div>`
  ).join("");
}

/* ================= PELOTAZOS ================= */

function generarPelotazos(p){
  const c=p.querySelector(".pelotazos");
  for(let i=0;i<2800;i++){
    const d=document.createElement("div");
    const s=Math.random()*4+2;
    d.className="pelota-bg";
    d.style.width=d.style.height=s+"px";
    d.style.left=Math.random()*900+"px";
    d.style.top=Math.random()*1400+"px";
    c.appendChild(d);
  }
}

/* ================= NUEVA P√ÅGINA ================= */

function nuevaPagina(){
  const p=document.createElement("div");
  p.className="pagina";

  p.innerHTML=`
  <div class="pelotazos"></div>

  <div class="chapa"></div>

  <div class="header">
    <img src="/images/logo-larraun.png" class="logo left">
    <img src="/images/logo-fnp.png" class="logo right">

    <svg class="titulo-svg" viewBox="0 0 900 160">
      <defs>
        <path id="arco" d="M 120 110 A 330 330 0 0 1 780 110"/>
      </defs>

      <text>
        <textPath href="#arco" startOffset="50%" text-anchor="middle">
          LARRAUN PILOTA ELKARTEA
        </textPath>
      </text>

      <circle cx="450" cy="120" r="22" class="pelota"/>
      <path d="M428 120 Q450 98 472 120" class="costura"/>
      <path d="M428 120 Q450 142 472 120" class="costura"/>
    </svg>
  </div>

  <div class="chapa"></div>

  <div class="contenido"></div>

  <div class="chapa"></div>

  <div class="footer">
    <div class="pie-gris">
      <div class="logos-grid">${logosHTML()}</div>
    </div>
    <div class="suelo"></div>
  </div>
  `;

  document.getElementById("paginas").appendChild(p);
  generarPelotazos(p);
  return p;
}

/* ================= DESCANSOS ================= */

function esDescanso(p){
  return (
    !p.etxekoa ||
    !p.kanpokoak ||
    /descanso/i.test(p.lehiaketa||"")
  );
}

/* ================= PAGINADOR ================= */

window.addEventListener("load",()=>{

Promise.all([
  fetch("/data/cartelera-larraun.json").then(r=>r.json()),
  fetch("/data/partidos-no-oficiales.json").then(r=>r.json())
]).then(([oficiales,noOficiales])=>{

  oficiales = oficiales.filter(p=>!esDescanso(p));
  noOficiales = noOficiales.filter(p=>!esDescanso(p));

  const bloquesData=[
    {titulo:"ORDUTEGIAK",data:oficiales},
    {titulo:"BESTE TXAPELKETAK OFIZIALAK",data:noOficiales.filter(p=>String(p.ofiziala)==="true")},
    {titulo:"TXAPELKETAKAK EZ OFIZIALAK",data:noOficiales.filter(p=>String(p.ofiziala)!=="true")}
  ];

  let pagina=nuevaPagina();
  let cont=pagina.querySelector(".contenido");
  let altura=0;

  bloquesData.forEach(b=>{
    if(!b.data.length) return;

    const bloque=document.createElement("div");
    bloque.className="bloque";
    bloque.innerHTML=`<h2>${b.titulo}</h2>`;

    b.data.forEach(p=>{
      const local=/lekunberri|aldatz/i.test(p.fronton||"");
      bloque.innerHTML+=`
      <div class="grupo">
        <div class="grupo-header ${!local?'rojo':''}">
          üìÖ ${p.fecha} | ‚è∞ ${p.hora} | üìç ${p.fronton}
        </div>
        <div class="linea">
          <div class="zkia">${p.zkia}</div>
          <div class="etxekoa">${p.etxekoa}</div>
          <div class="kanpokoa">${p.kanpokoak}</div>
          <div class="lehiaketa">${p.lehiaketa||""}</div>
        </div>
      </div>`;
    });

    document.body.appendChild(bloque);
    const h=bloque.offsetHeight;
    document.body.removeChild(bloque);

    if(altura+h>CONTENIDO_MAX && altura>0){
      pagina=nuevaPagina();
      cont=pagina.querySelector(".contenido");
      altura=0;
    }

    cont.appendChild(bloque);
    altura+=h;
  });

});

});

/* ================= EXPORTAR ================= */

async function exportar(){
  const pags=[...document.querySelectorAll(".pagina")];
  let i=1;
  for(const p of pags){
    const c=await html2canvas(p,{scale:2,useCORS:true});
    const a=document.createElement("a");
    a.download=`kartela_${i++}.jpg`;
    a.href=c.toDataURL("image/jpeg",0.95);
    a.click();
  }
}

</script>

</body>
</html>
