<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="UTF-8" />
<title>Larraun Kartela</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>

/* =====================================================
   BASE
===================================================== */

body{
  margin:0;
  background:#1b4d31;
  font-family:"Trebuchet MS","Arial Black",sans-serif;
}

.exportar{
  text-align:center;
  margin:20px;
}

/* =====================================================
   P√ÅGINA A4 FIJA
===================================================== */

.pagina{
  width:900px;
  height:1400px;
  margin:25px auto;
  display:flex;
  flex-direction:column;
  position:relative;
  overflow:hidden;

  /* verde m√°s claro + rugoso */
  background:
    repeating-linear-gradient(45deg,#3f8159 0 2px,#3a7753 2px 4px),
    #3f8159;
}

/* =====================================================
   PELOTAZOS REALISTAS
===================================================== */

.pelotazos{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:0;
}

.pelota{
  position:absolute;
  border-radius:50%;
  background:#000;
  filter:blur(.3px);
}

/* =====================================================
   HEADER
===================================================== */

.chapa{
  height:14px;
  background:#000;
  z-index:2;
}

.header{
  flex:0 0 140px;
  background:#2c56c9;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 18px;
  color:#fff;

  /* efecto colch√≥n */
  box-shadow:
    inset 0 10px 14px rgba(255,255,255,.35),
    inset 0 -16px 20px rgba(0,0,0,.65);

  z-index:2;
}

.header img{
  height:60px;
}

/* ===== t√≠tulo curvado ===== */

.titulo-svg{
  height:90px;
}

/* =====================================================
   CONTENIDO
===================================================== */

.contenido{
  flex:1;
  padding:18px 22px;
  overflow:hidden;
  z-index:1;
}

.bloque{
  margin-bottom:18px;
}

.bloque h2{
  color:#fff;
  text-align:center;
  margin:12px 0;
  letter-spacing:2px;
}

/* =====================================================
   GRUPOS PARTIDOS
===================================================== */

.grupo{
  background:#fff;
  border-radius:10px;
  margin-top:8px;
  overflow:hidden;
  box-shadow:0 4px 10px rgba(0,0,0,.35);
}

.grupo-header{
  padding:8px 14px;
  font-weight:bold;
  color:#fff;
  background:#2c56c9;
}

.grupo-header.rojo{
  background:#b00000;
}

.linea{
  display:flex;
  gap:10px;
  padding:7px 10px;
  border-top:1px solid #ddd;
  font-weight:900;
}

.zkia{width:28px}
.etxekoa{color:#2c56c9}
.kanpokoa{color:#b00000}

.lehiaketa{
  margin-left:auto;
}

/* =====================================================
   FOOTER
===================================================== */

.footer{
  flex:0 0 260px;
  display:flex;
  flex-direction:column;
  z-index:2;
}

.pie-gris{
  background:#2b2b2b;
  padding:10px;
}

.suelo{
  background:#6e6e6e;
  flex:1;
}

/* logos */

.logos-grid{
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:8px;
}

.logo-item{
  background:#fff;
  padding:6px;
  border-radius:6px;
}

.logo-item img{
  width:100%;
  height:34px;
  object-fit:contain;
}

</style>
</head>


<body>

<div class="exportar">
<button onclick="exportar()">üì∏ DESKARGATU JPG</button>
</div>

<div id="paginas"></div>

<script>

/* =====================================================
   CONFIGURACI√ìN
===================================================== */

const CONTENIDO_MAX = 840; // ajustado para que jam√°s corte

/* =====================================================
   UTILIDADES
===================================================== */

function normalizaHora(h){
  return h ? h.slice(0,5) : "00:00";
}

function ordenar(data){
  return data.sort((a,b)=>{
    if(a.fecha!==b.fecha) return a.fecha.localeCompare(b.fecha);
    return normalizaHora(a.hora).localeCompare(normalizaHora(b.hora));
  });
}

function esDescanso(p){
  return (
    !p.etxekoa ||
    !p.kanpokoak ||
    /descanso/i.test(p.lehiaketa||"")
  );
}

/* =====================================================
   LOGOS
===================================================== */

const LOGOS=[
"aliprox.jpg","arbeondo.jpg","asadorepeleta.jpg","barainhoa.jpg","kotxera.jpg",
"barilargi.jpg","barlekuonberri.jpg","bego√±ajanaridenda.jpg","carniceriaartxueta.jpg",
"carpinteriahnosazpiroz.jpg","construccionesga√±arbe.jpg","construccionesgarciarenasaralegi.jpg",
"construccionesurangasaigos.jpg","fisioterapiaandoniayerdi.jpg","hotelayestaran.jpg",
"iseelectricidad.jpg","kattagorrielkartea.jpg","lacturale.jpg","lagunasesoria.jpg",
"maderasnasorena.jpg","maskarada.jpg","sojonatura.jpg","suacontrol.jpg","urzubi.jpg",
"ventamugiro.jpg","ekin.jpg","lakita.jpg","nekazari.jpg"
];

function logosHTML(){
  return LOGOS.map(f =>
    `<div class="logo-item"><img src="/images/patrocinio/${f}"></div>`
  ).join("");
}

/* =====================================================
   P√ÅGINA NUEVA
===================================================== */

function nuevaPagina(){

  const p=document.createElement("div");
  p.className="pagina";

  p.innerHTML=`
  <div class="pelotazos"></div>

  <div class="chapa"></div>

  <div class="header">

    <img src="/images/logo-larraun.png">

    <svg class="titulo-svg" viewBox="0 0 600 150">
      <defs>
        <path id="curva"
          d="M40 95 Q300 15 560 95" />
      </defs>

      <text fill="white" font-size="42" font-weight="900" letter-spacing="3">
        <textPath href="#curva" startOffset="50%" text-anchor="middle">
          LARRAUN PILOTA ELKARTEA
        </textPath>
      </text>

      <circle cx="300" cy="70" r="14" fill="white"/>
    </svg>

    <img src="/images/logo-fnp.png">

  </div>

  <div class="chapa"></div>

  <div class="contenido"></div>

  <div class="chapa"></div>

  <div class="footer">
    <div class="pie-gris">
      <div class="logos-grid">${logosHTML()}</div>
    </div>
    <div class="suelo"></div>
  </div>
  `;

  document.getElementById("paginas").appendChild(p);

  generarPelotazos(p);

  return p;
}

/* =====================================================
   PELOTAZOS DENSOS
===================================================== */

function generarPelotazos(pagina){

  const cont=pagina.querySelector(".pelotazos");

  for(let i=0;i<4200;i++){
    const d=document.createElement("div");
    const s=Math.random()*4+2;

    d.className="pelota";
    d.style.width=d.style.height=s+"px";
    d.style.left=Math.random()*900+"px";
    d.style.top=Math.random()*1400+"px";
    d.style.opacity=Math.random()*0.18+0.05;

    cont.appendChild(d);
  }
}

/* =====================================================
   PAGINADOR FINAL
===================================================== */

window.addEventListener("load",()=>{

Promise.all([
fetch("/data/cartelera-larraun.json").then(r=>r.json()),
fetch("/data/partidos-no-oficiales.json").then(r=>r.json())
]).then(([oficiales,noOficiales])=>{

oficiales = oficiales.filter(p=>!esDescanso(p));
noOficiales = noOficiales.filter(p=>!esDescanso(p));

const bloquesData=[
{titulo:"ORDUTEGIAK",data:ordenar(oficiales)},
{titulo:"BESTE TXAPELKETAK OFIZIALAK",data:ordenar(noOficiales.filter(p=>p.ofiziala))},
{titulo:"TXAPELKETAK EZ OFIZIALAK",data:ordenar(noOficiales.filter(p=>!p.ofiziala))}
];

let pagina=nuevaPagina();
let cont=pagina.querySelector(".contenido");
let altura=0;

bloquesData.forEach(b=>{

if(!b.data.length) return;

const grupos={};

b.data.forEach(p=>{
  const k=`${p.fecha}|${normalizaHora(p.hora)}|${p.fronton}`;
  if(!grupos[k]) grupos[k]=[];
  grupos[k].push(p);
});

const bloque=document.createElement("div");
bloque.className="bloque";
bloque.innerHTML=`<h2>${b.titulo}</h2>`;

Object.values(grupos).forEach(partidos=>{

  const p0=partidos[0];
  const local=/lekunberri|aldatz/i.test(p0.fronton||"");

  bloque.innerHTML+=`
  <div class="grupo">
    <div class="grupo-header ${!local?'rojo':''}">
      üìÖ ${p0.fecha} | ‚è∞ ${normalizaHora(p0.hora)} | üìç ${p0.fronton}
    </div>
    ${partidos.map(p=>`
      <div class="linea">
        <div class="zkia">${p.zkia}</div>
        <div class="etxekoa">${p.etxekoa}</div>
        <div class="kanpokoa">${p.kanpokoak}</div>
        <div class="lehiaketa">${p.lehiaketa||""}</div>
      </div>
    `).join("")}
  </div>`;
});

bloque.style.visibility="hidden";
document.body.appendChild(bloque);
const h=bloque.offsetHeight;
document.body.removeChild(bloque);
bloque.style.visibility="";

if(altura+h>CONTENIDO_MAX){
  pagina=nuevaPagina();
  cont=pagina.querySelector(".contenido");
  altura=0;
}

cont.appendChild(bloque);
altura+=h;

});

});

});

/* =====================================================
   EXPORTAR
===================================================== */

async function exportar(){

const paginas=[...document.querySelectorAll(".pagina")];

let i=1;

for(const p of paginas){
const canvas=await html2canvas(p,{scale:2,useCORS:true});
const a=document.createElement("a");
a.download=`kartela_${i++}.jpg`;
a.href=canvas.toDataURL("image/jpeg",0.95);
a.click();
}

}

</script>

</body>
</html>
